<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Swift Cart - Smart Shopping Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --accent-color: #ec4899;
            --high-priority: #ef4444;
            --medium-priority: #f59e0b;
            --low-priority: #10b981;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-color: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --whatsapp-color: #25d366;
            --completed-bg: #f1f5f9;
            --completed-text: #94a3b8;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --modal-overlay: rgba(0, 0, 0, 0.5);
            --notification-bg: #ffffff;
            --notification-text: #1e293b;
            --notification-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            --empty-state-icon-color: #cbd5e1;
            --share-list-controls-bg: #f8fafc;
            --share-list-item-number-bg: #f1f5f9;
            --priority-option-hover-bg: #f8fafc;
            --share-list-item-hover-bg: #f8fafc;
            --btn-cancel-bg: #e2e8f0;
            --btn-cancel-hover-bg: #cbd5e1;
            --profit-color: #10b981;
            --loss-color: #ef4444;
            --expenditure-color: #3b82f6;
            --pending-color: #f59e0b;
            --bought-color: #10b981;
            --google-blue: #4285f4;
            --google-red: #ea4335;
            --google-yellow: #fbbc05;
            --google-green: #34a853;
        }

        /* Dark mode variables */
        body.dark-mode {
            --bg-color: #0f172a;
            --card-bg: #1e293b;
            --text-color: #f1f5f9;
            --text-secondary: #94a3b8;
            --border-color: #334155;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -1px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.2);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
            --completed-bg: #1e293b;
            --completed-text: #64748b;
            --modal-overlay: rgba(0, 0, 0, 0.7);
            --notification-bg: #1e293b;
            --notification-text: #f1f5f9;
            --notification-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            --empty-state-icon-color: #475569;
            --share-list-controls-bg: #1e293b;
            --share-list-item-number-bg: #334155;
            --priority-option-hover-bg: #334155;
            --share-list-item-hover-bg: #334155;
            --btn-cancel-bg: #334155;
            --btn-cancel-hover-bg: #475569;
            --pending-color: #f59e0b;
            --bought-color: #10b981;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow-x: hidden;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            transition: background-color 0.3s ease, color 0.3s ease;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        /* Header Styles */
        header {
            background: var(--gradient-primary);
            color: white;
            padding: 1rem 0;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
        }

        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23ffffff" fill-opacity="0.1" d="M0,96L48,112C96,128,192,160,288,160C384,160,480,128,576,122.7C672,117,768,139,864,133.3C960,128,1056,96,1152,90.7C1248,85,1344,107,1392,117.3L1440,128L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>') no-repeat bottom;
            background-size: cover;
            opacity: 0.3;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .logo i {
            font-size: 2rem;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .logo i:hover {
            transform: scale(1.1);
        }

        .logo-text {
            display: flex;
            flex-direction: column;
        }

        .logo-text h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
            letter-spacing: -0.025em;
        }

        .logo-text p {
            font-size: 0.75rem;
            opacity: 0.9;
        }

        .header-stats {
            display: flex;
            gap: 1rem;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .stat-label {
            font-size: 0.625rem;
            opacity: 0.9;
        }

        /* Dark mode toggle - moved to logo area */
        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 2.5rem;
            height: 2.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-size: 1rem;
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        /* NEW: Authentication Section */
        .auth-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
        }

        .auth-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 0.5rem;
            padding: 0.5rem 1rem;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .auth-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.9);
        }

        .user-avatar {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        /* Main Content */
        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            padding-bottom: 6rem;
            min-height: calc(100vh - 120px);
        }

        /* Quick Add Section */
        .quick-add {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-md);
            position: relative;
            overflow: hidden;
            position: sticky;
            top: 1rem;
            z-index: 10;
            transition: background-color 0.3s ease;
        }

        .quick-add::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: var(--gradient-primary);
        }

        .quick-add-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quick-input {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
            position: relative;
        }

        .quick-input input {
            flex: 1;
            min-width: 150px;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        .quick-input input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .quick-add-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .quick-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .quick-options {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .quick-option {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quick-option label {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-secondary);
            white-space: nowrap;
        }

        .quick-option input, .quick-option select {
            padding: 0.5rem;
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 0.75rem;
            transition: all 0.3s ease;
            min-width: 120px;
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        .quick-option input:focus, .quick-option select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* NEW: Custom store dropdown styles */
        .custom-store-input-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid var(--border-color);
        }

        .custom-store-input {
            flex: 1;
            padding: 0.5rem;
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 0.75rem;
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        .custom-store-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .save-store-btn {
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: 0.5rem;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .save-store-btn:hover {
            transform: scale(1.1);
        }

        .store-already-exists {
            color: var(--high-priority);
            font-size: 0.7rem;
            margin-top: 0.25rem;
            display: none;
        }

        /* UPDATED: Store management popup styles - Fixed text overlap */
        .store-management-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-overlay);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .store-management-content {
            background-color: var(--card-bg);
            border-radius: 1.5rem;
            padding: 1.5rem;
            width: 95%;
            max-width: 700px;
            max-height: 85vh;
            height: auto;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.3s ease;
            transition: background-color 0.3s ease;
            overflow: hidden;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .store-management-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
            flex-shrink: 0;
        }

        .store-management-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .store-management-title i {
            color: var(--primary-color);
        }

        .store-list-container {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 1rem;
        }

        .store-list {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.25rem; /* Reduced gap between store items */
        }

        /* UPDATED: Store item styles - Reduced height and padding */
        .store-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem; /* Reduced padding */
            border-radius: 0.5rem; /* Slightly smaller radius */
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
            transition: all 0.2s ease;
            min-height: 40px; /* Reduced min-height */
        }

        .store-item:hover {
            background-color: var(--share-list-item-hover-bg);
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .store-name {
            flex: 1;
            font-size: 0.9rem; /* Slightly smaller font */
            color: var(--text-color);
            font-weight: 500;
            word-break: break-word;
            overflow-wrap: break-word;
            max-width: 70%;
            padding-right: 1rem;
            line-height: 1.3; /* Reduced line height */
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .store-actions {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }

        /* UPDATED: Store action buttons - Smaller size */
        .store-edit-btn, .store-delete-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem; /* Reduced padding */
            width: 1.75rem; /* Smaller width */
            height: 1.75rem; /* Smaller height */
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            font-size: 0.8rem; /* Smaller icon */
        }

        .store-edit-btn:hover {
            background-color: rgba(99, 102, 241, 0.1);
            color: var(--primary-color);
        }

        .store-delete-btn:hover {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--high-priority);
        }

        .store-edit-btn.disabled, .store-delete-btn.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .store-edit-btn.disabled:hover, .store-delete-btn.disabled:hover {
            background: none;
            color: var(--text-secondary);
        }

        .store-edit-input {
            flex: 1;
            padding: 0.5rem;
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            background-color: var(--card-bg);
            color: var(--text-color);
            width: 100%;
        }

        .store-edit-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* NEW: Store dropdown with long-press support */
        .store-dropdown-container {
            position: relative;
        }

        .store-dropdown {
            width: 100%;
        }

        .store-management-icon {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            padding: 0.25rem;
            margin-left: 0.5rem;
            border-radius: 0.25rem;
            transition: all 0.2s ease;
        }

        .store-management-icon:hover {
            background-color: rgba(99, 102, 241, 0.1);
        }

        /* NEW: Store management footer */
        .store-management-footer {
            display: flex;
            justify-content: flex-end;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        /* NEW: Store item with compact layout for long names */
        .store-item.compact {
            padding: 0.5rem 0.75rem;
            min-height: 40px;
        }

        .store-item.compact .store-name {
            font-size: 0.875rem;
            max-width: 60%;
        }

        /* NEW: Store list with multi-column layout on wider screens */
        @media (min-width: 768px) {
            .store-list {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* NEW: Profit search styles */
        .profit-search-container {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-md);
            transition: background-color 0.3s ease;
        }

        .profit-search-input-wrapper {
            position: relative;
        }

        .profit-search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        .profit-search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .profit-search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .clear-profit-search {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: all 0.2s ease;
        }

        .clear-profit-search:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--text-color);
        }

        /* NEW: Updated Calendar Styles to match the image */
        .calendar-container {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .calendar-month-year {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .calendar-nav {
            display: flex;
            gap: 0.5rem;
        }

        .calendar-nav-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0.5rem;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .calendar-nav-btn:hover {
            background: var(--secondary-color);
        }

        .calendar-tabs {
            display: flex;
            background: var(--card-bg);
            border-radius: 0.75rem;
            padding: 0.25rem;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            transition: background-color 0.3s ease;
            margin-bottom: 1rem;
        }

        .calendar-tab {
            flex: 1;
            padding: 0.75rem;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.9rem;
        }

        .calendar-tab:hover {
            color: var(--text-color);
        }

        .calendar-tab.active {
            color: white;
            background: var(--gradient-primary);
            box-shadow: var(--shadow-sm);
        }

        /* DAY Calendar View */
        .calendar-day-view {
            display: none;
        }

        .calendar-day-view.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .calendar-weekday {
            text-align: center;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-secondary);
            padding: 0.5rem;
        }

        .calendar-days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
        }

        .calendar-day {
            aspect-ratio: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
            font-size: 0.9rem;
            position: relative;
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
        }

        .calendar-day.empty {
            visibility: hidden;
            pointer-events: none;
        }

        .calendar-day.has-data {
            background-color: rgba(16, 185, 129, 0.2);
            color: var(--text-color);
            font-weight: 600;
        }

        .calendar-day.has-data:hover {
            background-color: rgba(16, 185, 129, 0.3);
        }

        .calendar-day.selected {
            background: var(--gradient-primary);
            color: white;
            transform: scale(1.1);
            box-shadow: var(--shadow-md);
        }

        .calendar-day.today {
            border: 2px solid var(--primary-color);
        }

        .calendar-total {
            text-align: center;
            margin-top: 1rem;
            padding: 1rem;
            background: var(--gradient-primary);
            color: white;
            border-radius: 0.75rem;
            font-weight: 600;
            font-size: 1.1rem;
        }

        /* MONTH Calendar View - UPDATED */
        .calendar-month-view {
            display: none;
            position: relative;
            height: 300px;
            width: 100%;
        }

        .calendar-month-view.active {
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
        }

        .month-chart-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            width: 100%;
            position: relative;
        }

        .month-chart-wrapper {
            flex: 1;
            position: relative;
            height: 200px;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .month-chart-legend {
            margin-top: 15px;
            padding: 10px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
            max-height: 80px;
            overflow-y: auto;
            border-top: 1px solid var(--border-color);
            padding-top: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin: 2px 8px;
            font-size: 0.75rem;
            color: var(--text-color);
            white-space: normal;
            word-break: break-word;
            max-width: 150px;
            line-height: 1.2;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 6px;
            flex-shrink: 0;
        }

        /* NEW: Day Bill Popup Styles */
        .day-bill-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-overlay);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .day-bill-popup-content {
            background-color: var(--card-bg);
            border-radius: 1.5rem;
            width: 95%;
            max-width: 500px;
            max-height: 80vh;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.3s ease;
            transition: background-color 0.3s ease;
            overflow: hidden;
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
        }

        .day-bill-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 2px solid var(--border-color);
            flex-shrink: 0;
        }

        .day-bill-popup-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-color);
        }

        .day-bill-popup-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.25rem;
            cursor: pointer;
            width: 2rem;
            height: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.25rem;
            transition: all 0.2s ease;
        }

        .day-bill-popup-close:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--text-color);
        }

        .day-bill-popup-body {
            flex: 1;
            overflow-y: auto;
            padding: 0;
        }

        .day-bill-popup-total {
            font-size: 1.5rem;
            font-weight: 700;
            text-align: center;
            padding: 1.5rem;
            background: var(--gradient-primary);
            color: white;
            margin-bottom: 1rem;
        }

        .day-bill-popup-items {
            padding: 0 1.5rem 1.5rem;
        }

        .day-bill-popup-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .day-bill-popup-item:last-child {
            border-bottom: none;
        }

        .day-bill-popup-item-details {
            flex: 1;
        }

        .day-bill-popup-item-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 0.25rem;
        }

        .day-bill-popup-item-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .day-bill-popup-item-price {
            font-weight: 600;
            color: var(--text-color);
            font-size: 1.1rem;
        }

        .day-bill-popup-item-remove {
            background: none;
            border: none;
            color: var(--high-priority);
            cursor: pointer;
            padding: 0.5rem;
            margin-left: 1rem;
            border-radius: 0.25rem;
            transition: all 0.2s ease;
        }

        .day-bill-popup-item-remove:hover {
            background-color: rgba(239, 68, 68, 0.1);
        }

        /* Search Bar */
        .search-container {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-md);
            transition: background-color 0.3s ease;
        }

        .search-input-wrapper {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.3s ease;
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .clear-search {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: all 0.2s ease;
        }

        .clear-search:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--text-color);
        }

        /* Controls Section */
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
            justify-content: space-between;
            align-items: center;
        }

        .filter-sort-container {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        select, button {
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: 2px solid var(--border-color);
            background-color: var(--card-bg);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            color: var(--text-color);
        }

        button {
            background: var(--gradient-primary);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .share-btn {
            background: var(--gradient-secondary);
        }

        /* Tabs */
        .tabs-container {
            margin-bottom: 1.5rem;
        }

        .tabs {
            display: flex;
            background: var(--card-bg);
            border-radius: 0.75rem;
            padding: 0.25rem;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
            transition: background-color 0.3s ease;
        }

        .tab {
            flex: 1;
            padding: 0.5rem;
            cursor: pointer;
            font-weight: 500;
            color: var(--text-secondary);
            border-radius: 0.5rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.25rem;
            font-size: 0.75rem;
        }

        .tab:hover {
            color: var(--text-color);
        }

        .tab.active {
            color: white;
            background: var(--gradient-primary);
            box-shadow: var(--shadow-sm);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Store Sections */
        .store-section {
            margin-bottom: 1.5rem;
        }

        .store-header {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border-color);
            justify-content: space-between;
        }

        .store-name {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .store-count {
            background: #3b82f6;
            color: white;
            padding: 0.125rem 0.5rem;
            border-radius: 2rem;
            font-size: 0.625rem;
            font-weight: 600;
        }

        .items-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
            justify-content: start;
        }

        .store-total {
            color: var(--primary-color);
            text-align: right;
            padding: 0.5rem 1rem;
            font-weight: 600;
        }

        /* Item Cards */
        .item-card {
            background: var(--card-bg);
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            width: 100%;
        }

        .item-card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-xl);
        }

        .item-card.completed {
            background: var(--completed-bg);
            opacity: 0.8;
        }

        .item-card.completed .item-name {
            text-decoration: line-through;
            color: var(--completed-text);
        }

        .item-card.completed .item-details {
            color: var(--completed-text);
        }

        .priority-indicator {
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
        }

        .priority-high {
            background-color: var(--high-priority);
        }

        .priority-medium {
            background-color: var(--medium-priority);
        }

        .priority-low {
            background-color: var(--low-priority);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .item-name {
            font-weight: 600;
            font-size: 1rem;
            flex-grow: 1;
            margin-right: 0.5rem;
            color: var(--text-color);
            word-wrap: break-word;
            overflow-wrap: break-word;
            line-height: 1.4;
        }

        .item-actions {
            display: flex;
            gap: 0.25rem;
            flex-shrink: 0;
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            width: 1.75rem;
            height: 1.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.25rem;
            transition: all 0.2s ease;
        }

        .action-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--text-color);
        }

        .delete-btn:hover {
            background-color: rgba(239, 68, 68, 0.1);
            color: var(--high-priority);
        }

        .move-btn:hover {
            background-color: rgba(99, 102, 241, 0.1);
            color: var(--primary-color);
        }

        .item-details {
            display: flex;
            align-items: center;
            margin-bottom: 0.75rem;
            color: var(--text-secondary);
            font-size: 0.75rem;
        }

        .item-store {
            display: flex;
            align-items: center;
            margin-right: 0.75rem;
        }

        .item-priority {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            transition: background-color 0.2s ease;
        }

        .item-priority:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .priority-dot {
            width: 0.5rem;
            height: 0.5rem;
            border-radius: 50%;
            margin-right: 0.5rem;
        }

        .item-checkbox {
            display: flex;
            align-items: center;
        }

        .item-checkbox input {
            width: 1rem;
            height: 1rem;
            margin-right: 0.5rem;
            cursor: pointer;
        }

        .item-checkbox label {
            color: var(--text-color);
        }

        /* UPDATED: Completed Items Billing Section - Fixed duplicate total */
        .completed-billing {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            margin-top: 1.5rem;
            box-shadow: var(--shadow-md);
            transition: all 0.3s ease;
        }

        .completed-billing-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid var(--border-color);
        }

        .completed-billing-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Removed the duplicate total from header */
        .completed-billing-total {
            display: none; /* Hide the duplicate total */
        }

        .completed-billing-store {
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.75rem;
            overflow: hidden;
        }

        .completed-billing-store-header {
            background: var(--share-list-controls-bg);
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .completed-billing-store-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 0.25rem;
        }

        .completed-billing-store-total {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary-color);
        }

        .completed-billing-items {
            padding: 0;
        }

        .completed-billing-item {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            transition: all 0.2s ease;
        }

        .completed-billing-item:last-child {
            border-bottom: none;
        }

        .completed-billing-item:hover {
            background-color: var(--share-list-item-hover-bg);
        }

        .completed-billing-item-details {
            flex: 1;
        }

        .completed-billing-item-name {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 0.25rem;
        }

        .completed-billing-item-description {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }

        .completed-billing-item-quantity {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .completed-billing-item-price {
            text-align: right;
            min-width: 120px;
        }

        .completed-billing-item-price-line {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.25rem;
        }

        .completed-billing-item-total {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .completed-billing-grand-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 2px solid var(--border-color);
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 2rem 1rem;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 3rem;
            margin-bottom: 0.75rem;
            color: var(--empty-state-icon-color);
        }

        .empty-state-text {
            font-size: 1rem;
            margin-bottom: 1rem;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-overlay);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: var(--card-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            width: 90%;
            max-width: 400px;
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.3s ease;
            transition: background-color 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .close-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.25rem;
            cursor: pointer;
            width: 1.75rem;
            height: 1.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 0.25rem;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--text-color);
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-color);
            font-size: 0.875rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.3s ease;
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-buttons {
            display: flex;
            gap: 0.75rem;
            justify-content: flex-end;
            margin-top: 1rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }

        .btn-cancel {
            background-color: var(--btn-cancel-bg);
            color: var(--text-color);
        }

        .btn-cancel:hover {
            background-color: var(--btn-cancel-hover-bg);
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Priority Options */
        .priority-options {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .priority-option {
            display: flex;
            align-items: center;
            padding: 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .priority-option:hover {
            background-color: var(--priority-option-hover-bg);
        }

        .priority-option.selected {
            background-color: rgba(99, 102, 241, 0.1);
            border-color: var(--primary-color);
        }

        .priority-option-dot {
            width: 1rem;
            height: 1rem;
            border-radius: 50%;
            margin-right: 0.75rem;
        }

        .priority-option-text {
            font-size: 0.875rem;
            color: var(--text-color);
        }

        /* Cart Modal - Full Screen */
        .cart-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--card-bg);
            z-index: 1000;
        }

        .cart-modal-content {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
            overflow: hidden;
        }

        .cart-header {
            background: var(--gradient-primary);
            color: white;
            padding: 1rem;
            text-align: center;
            position: relative;
            flex-shrink: 0;
        }

        .cart-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .cart-subtitle {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-top: 0.25rem;
        }

        .cart-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background-color: var(--share-list-controls-bg);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .select-all-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .select-all-container input {
            width: 1rem;
            height: 1rem;
        }

        .select-all-container label {
            color: var(--text-color);
            font-weight: 500;
        }

        .cart-actions {
            display: flex;
            gap: 0.5rem;
        }

        .cart-close {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 1rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: all 0.2s ease;
        }

        .cart-close:hover {
            background-color: rgba(99, 102, 241, 0.1);
        }

        .whatsapp-share-btn {
            background-color: var(--whatsapp-color);
            color: white;
            border: none;
            border-radius: 0.5rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            transition: all 0.2s ease;
        }

        .whatsapp-share-btn:hover {
            background-color: #128c7e;
        }

        .cart-items {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            -webkit-overflow-scrolling: touch;
        }

        .cart-store-section {
            margin-bottom: 1rem;
        }

        .cart-store-header {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            background-color: var(--share-list-controls-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .cart-store-select-all {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
        }

        .cart-store-select-all input {
            width: 1rem;
            height: 1rem;
        }

        .cart-store-select-all label {
            color: var(--text-color);
            font-weight: 600;
            font-size: 1rem;
        }

        .cart-store-count {
            background: #3b82f6;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .cart-store-items {
            background-color: var(--card-bg);
        }

        .cart-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--card-bg);
            transition: all 0.2s ease;
        }

        .cart-item:hover {
            background-color: var(--share-list-item-hover-bg);
        }

        .cart-item:last-child {
            border-bottom: none;
        }

        .cart-item-checkbox {
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 1rem;
            cursor: pointer;
            flex-shrink: 0;
        }

        .cart-item-details {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .cart-item-name {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .cart-item-quantity {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .quantity-btn {
            width: 2rem;
            height: 2rem;
            border: 1px solid var(--border-color);
            background: var(--card-bg);
            color: var(--text-color);
            border-radius: 0.25rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            font-size: 0.875rem;
        }

        .quantity-btn:hover {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .quantity-value {
            min-width: 2rem;
            text-align: center;
            font-weight: 600;
        }

        .cart-item-price {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .price-input {
            width: 80px;
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            font-size: 0.875rem;
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        .price-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .price-input:disabled {
            background-color: var(--share-list-item-hover-bg);
            cursor: not-allowed;
        }

        .lock-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: all 0.2s ease;
        }

        .lock-btn:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--text-color);
        }

        .lock-btn.locked {
            color: var(--primary-color);
        }

        .cart-item-total {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1rem;
            margin-left: 1rem;
        }

        /* NEW: Cart Item Sale Price Section */
        .cart-item-sale-price {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: 1rem;
        }

        .sale-price-input {
            width: 80px;
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            font-size: 0.875rem;
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        .sale-price-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .sale-price-input:disabled {
            background-color: var(--share-list-item-hover-bg);
            cursor: not-allowed;
        }

        .cart-item-profit {
            font-weight: 600;
            color: var(--profit-color);
            font-size: 1rem;
            margin-left: 1rem;
            min-width: 80px;
            text-align: right;
        }

        .cart-item-profit.negative {
            color: var(--loss-color);
        }

        .cart-store-total {
            color: var(--primary-color);
            text-align: right;
            padding: 0.5rem 1rem;
            font-weight: 600;
        }

        /* Billing Section */
        .billing-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--card-bg);
            z-index: 1000;
        }

        .billing-modal-content {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
            overflow: hidden;
        }

        .billing-header {
            background: var(--gradient-primary);
            color: white;
            padding: 1rem;
            text-align: center;
            position: relative;
            flex-shrink: 0;
        }

        .billing-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .billing-subtitle {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-top: 0.25rem;
        }

        .billing-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background-color: var(--share-list-controls-bg);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .billing-actions {
            display: flex;
            gap: 0.5rem;
        }

        .billing-close {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 1rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: all 0.2s ease;
        }

        .billing-close:hover {
            background-color: rgba(99, 102, 241, 0.1);
        }

        .billing-items {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            -webkit-overflow-scrolling: touch;
        }

        .billing-store-section {
            margin-bottom: 1rem;
        }

        .billing-store-header {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            background-color: var(--share-list-controls-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .billing-store-name {
            color: var(--text-color);
            font-weight: 600;
            font-size: 1.1rem;
            flex: 1;
        }

        .billing-store-subtotal {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1rem;
        }

        .billing-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--card-bg);
            transition: all 0.2s ease;
        }

        .billing-item:hover {
            background-color: var(--share-list-item-hover-bg);
        }

        .billing-item:last-child {
            border-bottom: none;
        }

        .billing-item-name {
            flex: 1;
            font-size: 0.95rem;
            color: var(--text-color);
        }

        .billing-item-quantity {
            min-width: 3rem;
            text-align: center;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .billing-item-price {
            min-width: 4rem;
            text-align: right;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .billing-item-total {
            min-width: 4rem;
            text-align: right;
            font-weight: 600;
            color: var(--text-color);
        }

        .billing-summary {
            background-color: var(--share-list-controls-bg);
            padding: 1rem;
            border-top: 2px solid var(--border-color);
            flex-shrink: 0;
        }

        .billing-grand-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        /* Share List Modal - Full Screen */
        .share-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--card-bg);
            z-index: 1000;
        }

        .share-modal-content {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            animation: fadeIn 0.3s ease;
            overflow: hidden;
        }

        .share-list-header {
            background: var(--gradient-primary);
            color: white;
            padding: 1rem;
            text-align: center;
            position: relative;
            flex-shrink: 0;
        }

        .share-list-title {
            font-size: 1.5rem;
            font-weight: 600;
        }

        .share-list-date {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-top: 0.25rem;
        }

        .share-list-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background-color: var(--share-list-controls-bg);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .share-list-actions {
            display: flex;
            gap: 0.5rem;
        }

        .share-list-close {
            background: none;
            border: none;
            color: var(--primary-color);
            font-size: 1rem;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: all 0.2s ease;
        }

        .share-list-close:hover {
            background-color: rgba(99, 102, 241, 0.1);
        }

        .share-list-items {
            flex: 1;
            overflow-y: auto;
            padding: 0;
            -webkit-overflow-scrolling: touch;
        }

        .share-store-section {
            margin-bottom: 1rem;
        }

        .share-store-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 1rem;
            background-color: var(--share-list-controls-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .share-store-info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
        }

        .share-store-name {
            color: var(--text-color);
            font-weight: 600;
            font-size: 1.1rem;
        }

        .share-store-count {
            background: #3b82f6;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 2rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .share-store-total {
            font-weight: 600;
            color: var(--primary-color);
            margin-left: auto;
            padding-left: 1rem;
        }

        .share-store-items {
            background-color: var(--card-bg);
        }

        .share-list-item {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--card-bg);
            transition: all 0.2s ease;
        }

        .share-list-item:hover {
            background-color: var(--share-list-item-hover-bg);
        }

        .share-list-item:last-child {
            border-bottom: none;
        }

        .share-list-item-number {
            width: 2rem;
            height: 2rem;
            margin-right: 1rem;
            border-radius: 50%;
            background-color: var(--share-list-item-number-bg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-secondary);
            flex-shrink: 0;
        }

        .share-list-item-checkbox {
            width: 1.25rem;
            height: 1.25rem;
            margin-right: 1rem;
            cursor: pointer;
            flex-shrink: 0;
        }

        .share-list-item-name {
            flex: 1;
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-color);
        }

        .share-summary {
            background-color: var(--share-list-controls-bg);
            padding: 1rem;
            border-top: 2px solid var(--border-color);
        }

        .share-grand-total {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        /* Notification Toast - Enhanced Design */
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--notification-bg);
            color: var(--notification-text);
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: var(--notification-shadow);
            z-index: 1000;
            display: none;
            animation: slideUp 0.3s ease;
            max-width: 90%;
            min-width: 250px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .notification.error {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .notification.success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .notification.info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .notification-icon {
            font-size: 1.25rem;
            flex-shrink: 0;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 2px;
            font-size: 0.875rem;
        }

        .notification-message {
            font-size: 0.75rem;
            opacity: 0.9;
        }

        .notification-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.8);
            cursor: pointer;
            font-size: 1rem;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .notification-close:hover {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        /* Floating Add Button for Mobile */
        .floating-add-btn {
            display: none;
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            width: 3rem;
            height: 3rem;
            border-radius: 50%;
            background: var(--gradient-primary);
            color: white;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            z-index: 100;
            transition: all 0.3s ease;
        }

        .floating-add-btn:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-xl);
        }

        /* Safe area for mobile devices */
        @supports (padding-bottom: env(safe-area-inset-bottom)) {
            .floating-add-btn {
                bottom: calc(1rem + env(safe-area-inset-bottom));
                right: calc(1rem + env(safe-area-inset-right));
            }
        }

        /* NEW: Profit & Analytics Styles */
        .summary {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .summary-card {
            background: var(--card-bg);
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: var(--shadow-md);
            flex: 1;
            min-width: 200px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .summary-card.expenditure {
            border-left: 4px solid var(--expenditure-color);
        }

        .summary-card.sales {
            border-left: 4px solid var(--profit-color);
        }

        .summary-card.profit {
            border-left: 4px solid var(--profit-color);
        }

        .summary-card.loss {
            border-left: 4px solid var(--loss-color);
        }

        .summary-card.records {
            border-left: 4px solid var(--primary-color);
        }

        .summary-card-title {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }

        .summary-card-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .summary-card-value.expenditure {
            color: var(--expenditure-color);
        }

        .summary-card-value.sales {
            color: var(--profit-color);
        }

        .summary-card-value.profit {
            color: var(--profit-color);
        }

        .summary-card-value.loss {
            color: var(--loss-color);
        }

        .summary-card-value.records {
            color: var(--primary-color);
        }

        .chart-container {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-md);
        }

        .chart-title {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .profit-items {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-md);
        }

        .profit-store-section {
            margin-bottom: 1rem;
        }

        .profit-store-header {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            background-color: var(--share-list-controls-bg);
            border-bottom: 1px solid var(--border-color);
        }

        .profit-store-name {
            color: var(--text-color);
            font-weight: 600;
            font-size: 1.1rem;
            flex: 1;
        }

        .profit-store-subtotal {
            font-weight: 600;
            color: var(--primary-color);
            font-size: 1rem;
        }

        .profit-item {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--card-bg);
            transition: all 0.2s ease;
            gap: 0.5rem;
        }

        .profit-item:hover {
            background-color: var(--share-list-item-hover-bg);
        }

        .profit-item:last-child {
            border-bottom: none;
        }

        .profit-item-name {
            font-size: 0.95rem;
            color: var(--text-color);
        }

        .profit-item-quantity {
            text-align: center;
            font-weight: 500;
            color: var(--text-secondary);
        }

        .profit-item-buying, .profit-item-selling {
            width: 100%;
            padding: 0.25rem 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            font-size: 0.875rem;
            background-color: var(--card-bg);
            color: var(--text-color);
        }

        .profit-item-buying:focus, .profit-item-selling:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .profit-item-profit {
            text-align: right;
            font-weight: 600;
            color: var(--text-color);
        }

        .profit-item-profit.positive {
            color: var(--profit-color);
        }

        .profit-item-profit.negative {
            color: var(--loss-color);
        }

        /* NEW: Google Sign-In Button Styles */
        .google-signin-btn {
            background: white;
            color: #757575;
            border: 1px solid #dadce0;
            border-radius: 4px;
            padding: 10px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .google-signin-btn:hover {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }

        .google-signin-btn:active {
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            transform: translateY(0);
        }

        .google-icon {
            width: 18px;
            height: 18px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 0.75rem;
                text-align: center;
            }

            .header-stats {
                width: 100%;
                justify-content: space-around;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .filter-sort-container {
                width: 100%;
                justify-content: space-between;
            }

            .items-container {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
            }
            
            .quick-add {
                position: relative;
                top: 0;
                margin-bottom: 1rem;
            }
            
            .quick-input {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .quick-input input {
                min-width: auto;
            }
            
            .quick-options {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .quick-option {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .quick-option input, .quick-option select {
                width: 100%;
            }
            
            .floating-add-btn {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            main {
                padding-bottom: 5rem;
            }

            .profit-item {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .profit-item-name {
                grid-column: 1 / -1;
                font-weight: 600;
            }

            .summary {
                flex-direction: column;
            }

            #profitChart {
                height: 120px !important;
            }

            /* NEW: Responsive calendar adjustments */
            .calendar-days-grid {
                gap: 0.25rem;
            }

            .calendar-day {
                font-size: 0.8rem;
            }

            .calendar-weekday {
                font-size: 0.75rem;
                padding: 0.25rem;
            }

            .calendar-tab {
                padding: 0.5rem;
                font-size: 0.8rem;
            }

            .day-bill-popup-content {
                width: 98%;
                max-height: 90vh;
            }

            .day-bill-popup-header {
                padding: 1rem;
            }

            .day-bill-popup-items {
                padding: 0 1rem 1rem;
            }

            /* Responsive adjustments for the chart */
            .calendar-month-view {
                height: 280px;
            }
            
            .month-chart-wrapper {
                height: 180px;
            }
            
            .month-chart-legend {
                max-height: 70px;
                gap: 6px;
            }
            
            .legend-item {
                font-size: 0.7rem;
                max-width: 130px;
                margin: 1px 6px;
            }
            
            /* NEW: Responsive auth section */
            .auth-section {
                margin-top: 0.5rem;
            }
            
            .auth-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
            
            .user-info {
                font-size: 0.7rem;
            }
        }

        /* Small mobile devices */
        @media (max-width: 480px) {
            .floating-add-btn {
                bottom: 0.75rem;
                right: 0.75rem;
                width: 2.75rem;
                height: 2.75rem;
                font-size: 1.125rem;
            }
            
            @supports (padding-bottom: env(safe-area-inset-bottom)) {
                .floating-add-btn {
                    bottom: calc(0.75rem + env(safe-area-inset-bottom));
                    right: calc(0.75rem + env(safe-area-inset-right));
                }
            }
            
            .cart-item {
                padding: 0.5rem 0.75rem;
            }
            
            .cart-item-checkbox {
                width: 1rem;
                height: 1rem;
                margin-right: 0.75rem;
            }
            
            .cart-item-name {
                font-size: 0.875rem;
            }
            
            .quantity-btn {
                width: 1.75rem;
                height: 1.75rem;
                font-size: 0.75rem;
            }
            
            .price-input, .sale-price-input {
                width: 60px;
                font-size: 0.75rem;
            }
            
            .billing-item {
                padding: 0.5rem 0.75rem;
            }
            
            .billing-item-name {
                font-size: 0.875rem;
            }
            
            .billing-item-quantity,
            .billing-item-price,
            .billing-item-total {
                font-size: 0.75rem;
                min-width: 2.5rem;
            }

            .cart-item-sale-price, .cart-item-profit {
                margin-left: 0.5rem;
            }

            #profitChart {
                height: 100px !important;
            }

            /* NEW: Small mobile adjustments for calendar */
            .calendar-days-grid {
                gap: 0.1rem;
            }

            .calendar-day {
                font-size: 0.7rem;
            }

            .calendar-weekday {
                font-size: 0.7rem;
            }

            .calendar-total {
                font-size: 1rem;
                padding: 0.75rem;
            }

            /* Small mobile adjustments for the chart */
            .calendar-month-view {
                height: 250px;
            }
            
            .month-chart-wrapper {
                height: 150px;
            }
            
            .month-chart-legend {
                max-height: 60px;
                gap: 4px;
            }
            
            .legend-item {
                font-size: 0.65rem;
                max-width: 110px;
                margin: 1px 4px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-shopping-cart" id="cartIcon" title="Open Cart"></i>
                <div class="logo-text">
                    <h1>Swift Cart</h1>
                    <p>Smart Shopping Assistant</p>
                </div>
                <button class="theme-toggle" id="themeToggle" title="Toggle dark mode">
                    <i class="fas fa-sun" id="themeIcon"></i>
                </button>
            </div>
            <div class="header-stats">
                <div class="stat">
                    <div class="stat-value" id="activeCount">0</div>
                    <div class="stat-label">Active Items</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="completedCount">0</div>
                    <div class="stat-label">Completed</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="storeCount">0</div>
                    <div class="stat-label">Stores</div>
                </div>
            </div>
            <!-- NEW: Authentication Section in Header -->
            <div class="auth-section">
                <button id="googleSignInBtn" class="auth-btn">
                    <i class="fab fa-google"></i>
                    Sign in with Google
                </button>
                <button id="logoutBtn" class="auth-btn" style="display: none;">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
                <div id="userEmail" class="user-info">Not signed in</div>
            </div>
        </div>
    </header>

    <main>
        <div class="quick-add">
            <h2 class="quick-add-title">
                <i class="fas fa-plus-circle"></i>
                Quick Add Item
            </h2>
            <div class="quick-input">
                <input type="text" id="quickItemName" placeholder="Item name (e.g., Milk)" data-product-input>
                <button class="quick-add-btn" id="quickAddBtn">
                    <i class="fas fa-plus"></i>
                    Add Item
                </button>
            </div>
            <div class="quick-options">
                <div class="quick-option store-dropdown-container">
                    <label for="quickItemStore">Store:</label>
                    <div style="display: flex; align-items: center;">
                        <select id="quickItemStore" class="store-dropdown">
                            <option value="Aslam Karyana Store">Aslam Karyana Store</option>
                            <option value="Adrees Karyana Store">Adrees Karyana Store</option>
                            <option value="Amir Karyana Store">Amir Karyana Store</option>
                            <option value="Waqas Rangwala">Waqas Rangwala</option>
                            <option value="Babar Jafar Karyana Store">Babar Jafar Karyana Store</option>
                            <option value="Baloch Karyana Store">Baloch Karyana Store</option>
                            <option value="Bakery">Bakery</option>
                            <option value="Other">Other</option>
                        </select>
                        <button class="store-management-icon" id="storeManagementBtn" title="Manage Stores">
                            <i class="fas fa-cog"></i>
                        </button>
                    </div>
                </div>
                <div class="quick-option" id="customStoreOption" style="display: none;">
                    <label for="customStore">Custom Store:</label>
                    <div class="custom-store-input-container">
                        <input type="text" id="customStore" class="custom-store-input" placeholder="Enter store name">
                        <button class="save-store-btn" id="saveCustomStoreBtn" title="Save this store">
                            <i class="fas fa-check"></i>
                        </button>
                    </div>
                    <div class="store-already-exists" id="storeAlreadyExists">Store already exists</div>
                </div>
                <div class="quick-option">
                    <label for="quickItemPriority">Priority:</label>
                    <select id="quickItemPriority">
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                        <option value="low">Low</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="search-container">
            <div class="search-input-wrapper">
                <i class="fas fa-search search-icon"></i>
                <input type="text" class="search-input" id="searchInput" placeholder="Search items by name...">
                <button class="clear-search" id="clearSearchBtn" title="Clear search">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        </div>

        <div class="controls">
            <div class="filter-sort-container">
                <select id="filterStore">
                    <option value="all">All Stores</option>
                </select>
                <select id="filterPriority">
                    <option value="all">All Priorities</option>
                    <option value="high">High Priority</option>
                    <option value="medium">Medium Priority</option>
                    <option value="low">Low Priority</option>
                </select>
                <select id="sortBy">
                    <option value="priority">Sort by Priority</option>
                    <option value="store">Sort by Store</option>
                    <option value="name">Sort by Name</option>
                </select>
            </div>
            <button class="share-btn" id="shareListBtn">
                <i class="fab fa-whatsapp"></i>
                Share List
            </button>
        </div>

        <div class="tabs-container">
            <div class="tabs">
                <div class="tab active" data-tab="active">
                    <i class="fas fa-shopping-basket"></i>
                    Active Items
                </div>
                <div class="tab" data-tab="completed">
                    <i class="fas fa-check-circle"></i>
                    Completed Items
                </div>
                <div class="tab" data-tab="billing">
                    <i class="fas fa-receipt"></i>
                    Billing
                </div>
                <div class="tab" data-tab="profit">
                    <i class="fas fa-chart-bar"></i>
                    Profit & Analysis
                </div>
            </div>
            
            <div class="tab-content active" id="active-tab">
                <div id="activeItemsContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-shopping-basket"></i>
                        </div>
                        <p class="empty-state-text">No active items. Add your first shopping item!</p>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="completed-tab">
                <!-- NEW: Updated Calendar Container -->
                <div class="calendar-container">
                    <div class="calendar-header">
                        <div class="calendar-month-year" id="calendarMonthYear">October 2025</div>
                        <div class="calendar-nav">
                            <button class="calendar-nav-btn" id="calendarPrevMonth">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <button class="calendar-nav-btn" id="calendarNextMonth">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>

                    <div class="calendar-tabs">
                        <div class="calendar-tab active" data-calendar-view="day">
                            <i class="fas fa-calendar-day"></i>
                            DAY
                        </div>
                        <div class="calendar-tab" data-calendar-view="month">
                            <i class="fas fa-chart-pie"></i>
                            MONTH
                        </div>
                    </div>

                    <!-- DAY View -->
                    <div class="calendar-day-view active" id="calendarDayView">
                        <div class="calendar-weekdays">
                            <div class="calendar-weekday">SUN</div>
                            <div class="calendar-weekday">MON</div>
                            <div class="calendar-weekday">TUE</div>
                            <div class="calendar-weekday">WED</div>
                            <div class="calendar-weekday">THU</div>
                            <div class="calendar-weekday">FRI</div>
                            <div class="calendar-weekday">SAT</div>
                        </div>
                        <div class="calendar-days-grid" id="calendarDaysGrid">
                            <!-- Calendar days will be populated here -->
                        </div>
                        <div class="calendar-total" id="calendarDayTotal">
                            Total: Rs 0.00
                        </div>
                    </div>

                    <!-- MONTH View - UPDATED -->
                    <div class="calendar-month-view" id="calendarMonthView">
                        <div class="month-chart-container">
                            <div class="month-chart-wrapper">
                                <canvas id="monthChart"></canvas>
                            </div>
                            <!-- Legend will be populated here -->
                        </div>
                    </div>
                </div>

                <div id="completedItemsContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <p class="empty-state-text">No completed items for this date.</p>
                    </div>
                </div>

                <!-- Billing Summary for Completed Items -->
                <div class="completed-billing" id="completedBilling" style="display: none;">
                    <div class="completed-billing-header">
                        <div class="completed-billing-title">Billing Summary</div>
                    </div>
                    <div id="completedBillingStores">
                        <!-- Store bills will be populated here -->
                    </div>
                    <div class="completed-billing-grand-total">
                        <span>Grand Total:</span>
                        <span id="completedGrandTotal">Rs 0.00</span>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="billing-tab">
                <div id="billingContainer">
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <p class="empty-state-text">No items to bill. Add items to your cart first!</p>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="profit-tab">
                <div id="profitContainer">
                    <div class="summary">
                        <div class="summary-card records">
                            <div class="summary-card-title">Total Records</div>
                            <div class="summary-card-value records" id="totalRecords">0</div>
                        </div>
                        <div class="summary-card records">
                            <div class="summary-card-title">Completed Items</div>
                            <div class="summary-card-value records" id="completedItems">0</div>
                        </div>
                        <div class="summary-card expenditure">
                            <div class="summary-card-title">Total Expenditure</div>
                            <div class="summary-card-value expenditure" id="totalExpenditure">Rs 0.00</div>
                        </div>
                        <div class="summary-card sales">
                            <div class="summary-card-title">Total Sales</div>
                            <div class="summary-card-value sales" id="totalSales">Rs 0.00</div>
                        </div>
                        <div class="summary-card profit" id="profitSummaryCard">
                            <div class="summary-card-title">Total Profit</div>
                            <div class="summary-card-value profit" id="totalProfit">Rs 0.00</div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h3 class="chart-title">
                            <i class="fas fa-chart-line"></i>
                            Financial Overview
                        </h3>
                        <canvas id="profitChart" height="150"></canvas>
                    </div>

                    <!-- NEW: Profit Search Section -->
                    <div class="profit-search-container">
                        <div class="profit-search-input-wrapper">
                            <i class="fas fa-search profit-search-icon"></i>
                            <input type="text" class="profit-search-input" id="profitSearchInput" placeholder="Search profit items by name...">
                            <button class="clear-profit-search" id="clearProfitSearchBtn" title="Clear search">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>

                    <div class="profit-items">
                        <h3 class="chart-title">
                            <i class="fas fa-list"></i>
                            Profit Breakdown
                        </h3>
                        <div id="profitItems">
                            <div class="empty-state">
                                <div class="empty-state-icon">
                                    <i class="fas fa-chart-bar"></i>
                                </div>
                                <p class="empty-state-text">No completed items for profit analysis yet.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Floating Add Button for Mobile -->
    <button class="floating-add-btn" id="floatingAddBtn">
        <i class="fas fa-plus"></i>
    </button>

    <!-- UPDATED: Store Management Popup - Removed Add Store Form -->
    <div class="store-management-popup" id="storeManagementPopup">
        <div class="store-management-content">
            <div class="store-management-header">
                <h3 class="store-management-title"><i class="fas fa-store"></i>Manage Stores</h3>
                <button class="close-btn" id="closeStoreManagementPopup">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="store-list-container">
                <div class="store-list" id="storeList">
                    <!-- Store list will be populated here -->
                </div>
            </div>
            <div class="store-management-footer">
                <button class="btn btn-primary" id="closeStoreManagementBtn">Done</button>
            </div>
        </div>
    </div>

    <!-- NEW: Day Bill Popup -->
    <div class="day-bill-popup" id="dayBillPopup">
        <div class="day-bill-popup-content">
            <div class="day-bill-popup-header">
                <h3 class="day-bill-popup-title" id="dayBillPopupTitle">Day Bill</h3>
                <button class="day-bill-popup-close" id="dayBillPopupClose">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="day-bill-popup-body">
                <div class="day-bill-popup-total" id="dayBillPopupTotal">
                    Total: Rs 0.00
                </div>
                <div class="day-bill-popup-items" id="dayBillPopupItems">
                    <!-- Items will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Priority Selector Modal -->
    <div class="modal" id="priorityModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Change Priority</h3>
                <button class="close-btn" id="priorityCloseBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="priority-options">
                <div class="priority-option" data-priority="high">
                    <div class="priority-option-dot priority-high"></div>
                    <div class="priority-option-text">High Priority</div>
                </div>
                <div class="priority-option" data-priority="medium">
                    <div class="priority-option-dot priority-medium"></div>
                    <div class="priority-option-text">Medium Priority</div>
                </div>
                <div class="priority-option" data-priority="low">
                    <div class="priority-option-dot priority-low"></div>
                    <div class="priority-option-text">Low Priority</div>
                </div>
            </div>
            <div class="form-buttons">
                <button class="btn btn-cancel" id="priorityCancelBtn">Cancel</button>
                <button class="btn btn-primary" id="prioritySaveBtn">Save</button>
            </div>
        </div>
    </div>

    <!-- Move Item Modal -->
    <div class="modal" id="moveModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Move Item to Another Store</h3>
                <button class="close-btn" id="moveCloseBtn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="form-group">
                <label for="moveItemName">Item</label>
                <input type="text" id="moveItemName" readonly>
            </div>
            <div class="form-group">
                <label for="moveFromStore">From Store</label>
                <input type="text" id="moveFromStore" readonly>
            </div>
            <div class="form-group">
                <label for="moveToStore">To Store</label>
                <select id="moveToStore">
                    <option value="Aslam Karyana Store">Aslam Karyana Store</option>
                    <option value="Adrees Karyana Store">Adrees Karyana Store</option>
                    <option value="Amir Karyana Store">Amir Karyana Store</option>
                    <option value="Waqas Rangwala">Waqas Rangwala</option>
                    <option value="Babar Jafar Karyana Store">Babar Jafar Karyana Store</option>
                    <option value="Baloch Karyana Store">Baloch Karyana Store</option>
                    <option value="Bakery">Bakery</option>
                    <option value="Other">Other</option>
                </select>
            </div>
            <div class="form-group" id="moveCustomStoreOption" style="display: none;">
                <label for="moveCustomStore">Custom Store Name</label>
                <input type="text" id="moveCustomStore" placeholder="Enter store name">
            </div>
            <div class="form-buttons">
                <button class="btn btn-cancel" id="moveCancelBtn">Cancel</button>
                <button class="btn btn-primary" id="moveSaveBtn">Move Item</button>
            </div>
        </div>
    </div>

    <!-- Cart Modal - Full Screen -->
    <div class="cart-modal" id="cartModal">
        <div class="cart-modal-content">
            <div class="cart-header">
                <h2 class="cart-title">Shopping Cart</h2>
                <p class="cart-subtitle">Manage items, prices, and quantities</p>
            </div>
            <div class="cart-controls">
                <div class="select-all-container">
                    <input type="checkbox" id="cartSelectAllCheckbox">
                    <label for="cartSelectAllCheckbox">Select All Items</label>
                </div>
                <div class="cart-actions">
                    <button class="whatsapp-share-btn" id="cartShareListBtn">
                        <i class="fab fa-whatsapp"></i>
                        Share List
                    </button>
                    <button class="whatsapp-share-btn" id="cartWhatsappShareBtn">
                        <i class="fab fa-whatsapp"></i>
                        Share Bill
                    </button>
                    <button class="cart-close" id="closeCartModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="cart-items" id="cartItems">
                <!-- Items will be populated here -->
            </div>
        </div>
    </div>

    <!-- Billing Modal - Full Screen -->
    <div class="billing-modal" id="billingModal">
        <div class="billing-modal-content">
            <div class="billing-header">
                <h2 class="billing-title">Billing Summary</h2>
                <p class="billing-subtitle">Complete bill with totals</p>
            </div>
            <div class="billing-controls">
                <div class="billing-actions">
                    <button class="whatsapp-share-btn" id="billingWhatsappShareBtn">
                        <i class="fab fa-whatsapp"></i>
                        Share Bill
                    </button>
                    <button class="billing-close" id="closeBillingModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="billing-items" id="billingItems">
                <!-- Items will be populated here -->
            </div>
            <div class="billing-summary">
                <div class="billing-grand-total">
                    <span>Grand Total:</span>
                    <span id="grandTotalAmount">Rs 0.00</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Share List Modal - Full Screen -->
    <div class="share-modal" id="shareModal">
        <div class="share-modal-content">
            <div class="share-list-header">
                <h2 class="share-list-title" id="shareListTitle">Shopping List</h2>
                <p class="share-list-date" id="shareListDate"></p>
            </div>
            <div class="share-list-controls">
                <div class="select-all-container">
                    <input type="checkbox" id="selectAllCheckbox">
                    <label for="selectAllCheckbox">Select All</label>
                </div>
                <div class="share-list-actions">
                    <button class="whatsapp-share-btn" id="shareWhatsappShareBtn">
                        <i class="fab fa-whatsapp"></i>
                        Share via WhatsApp
                    </button>
                    <button class="share-list-close" id="closeShareModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="share-list-items" id="shareListItems">
                <!-- Items will be populated here -->
            </div>
        </div>
    </div>

    <!-- Notification Toast - Enhanced Design -->
    <div class="notification" id="notification" style="display: none;">
        <div class="notification-icon" id="notificationIcon">
            <i class="fas fa-exclamation-circle"></i>
        </div>
        <div class="notification-content">
            <div class="notification-title" id="notificationTitle">Notification</div>
            <div class="notification-message" id="notificationMessage">Message</div>
        </div>
        <button class="notification-close" id="notificationClose">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <!-- Firebase Configuration and Authentication Script -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-analytics.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDwEWJHsKJAYA5L8i67IycdayZvFI7nauk",
            authDomain: "swift-cart-756ff.firebaseapp.com",
            projectId: "swift-cart-756ff",
            storageBucket: "swift-cart-756ff.firebasestorage.app",
            messagingSenderId: "313785362296",
            appId: "1:313785362296:web:3a4dabdf6bd03549c44a8d",
            measurementId: "G-C18TKF4Y67",
            databaseURL: "https://swift-cart-756ff-default-rtdb.firebaseio.com/"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const provider = new GoogleAuthProvider();

        // Wait for DOM to be loaded
        document.addEventListener('DOMContentLoaded', () => {
            const googleSignInBtn = document.getElementById('googleSignInBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const userEmail = document.getElementById('userEmail');

            // Sign-in button
            googleSignInBtn.addEventListener('click', () => {
                signInWithPopup(auth, provider)
                .then((result) => {
                    const user = result.user;
                    userEmail.innerText = user.email;

                    // Save user data in Firebase Realtime Database
                    set(ref(db, 'users/' + user.uid), {
                        name: user.displayName,
                        email: user.email,
                        photoURL: user.photoURL,
                        lastLogin: new Date().toISOString()
                    });

                    // Show success notification
                    showNotification('Welcome!', `Signed in as ${user.displayName}`, false, 'success');
                    
                    // Update UI
                    googleSignInBtn.style.display = 'none';
                    logoutBtn.style.display = 'flex';
                })
                .catch((error) => {
                    console.error(error);
                    showNotification('Authentication Error', error.message, true, 'error');
                });
            });

            // Logout button
            logoutBtn.addEventListener('click', () => {
                signOut(auth).then(() => {
                    showNotification('Signed Out', 'You have been signed out successfully', false, 'info');
                    userEmail.innerText = 'Not signed in';
                    logoutBtn.style.display = 'none';
                    googleSignInBtn.style.display = 'flex';
                }).catch((error) => {
                    console.error(error);
                    showNotification('Sign Out Error', error.message, true, 'error');
                });
            });

            // Realtime auth state change
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userEmail.innerText = user.email;
                    googleSignInBtn.style.display = 'none';
                    logoutBtn.style.display = 'flex';
                } else {
                    userEmail.innerText = 'Not signed in';
                    googleSignInBtn.style.display = 'flex';
                    logoutBtn.style.display = 'none';
                }
            });
        });

        // Helper function to show notifications
        function showNotification(title, message, isError = false, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationIcon = document.getElementById('notificationIcon');
            const notificationTitle = document.getElementById('notificationTitle');
            const notificationMessage = document.getElementById('notificationMessage');
            
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            
            // Remove all notification classes
            notification.classList.remove('error', 'success', 'info');
            
            if (isError) {
                notification.classList.add('error');
                notificationIcon.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
            } else if (type === 'info') {
                notification.classList.add('info');
                notificationIcon.innerHTML = '<i class="fas fa-info-circle"></i>';
            } else {
                notification.classList.add('success');
                notificationIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
            }
            
            notification.style.display = 'flex';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                notification.style.display = 'none';
            }, 5000);
        }
    </script>

    <!-- Original Swift Cart Application Script -->
    <script>
        // Data management
        let items = [];
        let lastUsedStore = 'Aslam Karyana Store';
        let lastUsedPriority = 'medium';
        let selectedItems = new Set();
        let currentEditingItemId = null;
        let selectedPriority = null;
        let activeTab = 'active';
        let currentMovingItemId = null;
        let isDarkMode = false;
        let searchQuery = '';
        let suggestedProducts = []; // Now array of {name, frequency, lastUsedAt}
        let selectedSuggestionIndex = -1;
        let lockedPrices = {}; // Store locked prices by product name lowercased
        let lockedSalePrices = {}; // NEW: Store locked sale prices by product name lowercased
        let profitChart = null; // Store Chart.js instance
        let selectedDate = new Date().toISOString().split('T')[0]; // Today's date in YYYY-MM-DD
        let customStores = []; // Store custom stores
        let monthChart = null; // NEW: Store month chart instance
        let temporaryCustomStore = ''; // NEW: Track temporary custom store
        let isCalendarExpanded = false; // NEW: Track calendar state
        let searchTimeout = null; // NEW: Debounce search

        // NEW: Calendar state variables
        let currentCalendarMonth = new Date().getMonth();
        let currentCalendarYear = new Date().getFullYear();
        let selectedCalendarDate = new Date().toISOString().split('T')[0];

        // DOM elements
        const activeItemsContainer = document.getElementById('activeItemsContainer');
        const completedItemsContainer = document.getElementById('completedItemsContainer');
        const billingContainer = document.getElementById('billingContainer');
        const profitContainer = document.getElementById('profitContainer');
        const quickItemNameInput = document.getElementById('quickItemName');
        const quickInputContainer = document.querySelector('.quick-input');
        const quickItemStoreSelect = document.getElementById('quickItemStore');
        const customStoreOption = document.getElementById('customStoreOption');
        const customStoreInput = document.getElementById('customStore');
        const quickItemPrioritySelect = document.getElementById('quickItemPriority');
        const quickAddBtn = document.getElementById('quickAddBtn');
        const floatingAddBtn = document.getElementById('floatingAddBtn');
        const filterStoreSelect = document.getElementById('filterStore');
        const filterPrioritySelect = document.getElementById('filterPriority');
        const sortBySelect = document.getElementById('sortBy');
        const searchInput = document.getElementById('searchInput');
        const clearSearchBtn = document.getElementById('clearSearchBtn');
        const cartIcon = document.getElementById('cartIcon');
        const cartModal = document.getElementById('cartModal');
        const closeCartModal = document.getElementById('closeCartModal');
        const cartItems = document.getElementById('cartItems');
        const cartSelectAllCheckbox = document.getElementById('cartSelectAllCheckbox');
        const cartWhatsappShareBtn = document.getElementById('cartWhatsappShareBtn');
        const billingModal = document.getElementById('billingModal');
        const closeBillingModal = document.getElementById('closeBillingModal');
        const billingItems = document.getElementById('billingItems');
        const billingWhatsappShareBtn = document.getElementById('billingWhatsappShareBtn');
        const grandTotalAmount = document.getElementById('grandTotalAmount');
        const shareModal = document.getElementById('shareModal');
        const closeShareModal = document.getElementById('closeShareModal');
        const shareListTitle = document.getElementById('shareListTitle');
        const shareListDate = document.getElementById('shareListDate');
        const shareListItems = document.getElementById('shareListItems');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const shareWhatsappShareBtn = document.getElementById('shareWhatsappShareBtn');
        const shareListBtn = document.getElementById('shareListBtn');
        const notification = document.getElementById('notification');
        const notificationIcon = document.getElementById('notificationIcon');
        const notificationTitle = document.getElementById('notificationTitle');
        const notificationMessage = document.getElementById('notificationMessage');
        const notificationClose = document.getElementById('notificationClose');
        const themeToggle = document.getElementById('themeToggle');
        const themeIcon = document.getElementById('themeIcon');
        
        // Priority modal elements
        const priorityModal = document.getElementById('priorityModal');
        const priorityCloseBtn = document.getElementById('priorityCloseBtn');
        const priorityCancelBtn = document.getElementById('priorityCancelBtn');
        const prioritySaveBtn = document.getElementById('prioritySaveBtn');
        const priorityOptions = document.querySelectorAll('.priority-option');
        
        // Move modal elements
        const moveModal = document.getElementById('moveModal');
        const moveCloseBtn = document.getElementById('moveCloseBtn');
        const moveCancelBtn = document.getElementById('moveCancelBtn');
        const moveSaveBtn = document.getElementById('moveSaveBtn');
        const moveItemName = document.getElementById('moveItemName');
        const moveFromStore = document.getElementById('moveFromStore');
        const moveToStore = document.getElementById('moveToStore');
        const moveCustomStore = document.getElementById('moveCustomStore');
        const moveCustomStoreOption = document.getElementById('moveCustomStoreOption');
        
        // Date picker elements
        const completedDatePicker = document.getElementById('completedDatePicker');
        const prevDateBtn = document.getElementById('prevDateBtn');
        const nextDateBtn = document.getElementById('nextDateBtn');
        const completedBilling = document.getElementById('completedBilling');
        const completedBillingTotal = document.getElementById('completedBillingTotal');
        const completedBillingStores = document.getElementById('completedBillingStores');
        const completedGrandTotal = document.getElementById('completedGrandTotal');
        
        // Tab elements
        const tabs = document.querySelectorAll('.tab');
        
        // Stats elements
        const activeCount = document.getElementById('activeCount');
        const completedCount = document.getElementById('completedCount');
        const storeCount = document.getElementById('storeCount');

        // Profit elements
        const totalRecords = document.getElementById('totalRecords');
        const completedItemsEl = document.getElementById('completedItems');
        const totalExpenditure = document.getElementById('totalExpenditure');
        const totalSales = document.getElementById('totalSales');
        const totalProfit = document.getElementById('totalProfit');
        const profitSummaryCard = document.getElementById('profitSummaryCard');
        const profitItems = document.getElementById('profitItems');

        // NEW: Store management elements
        const storeManagementPopup = document.getElementById('storeManagementPopup');
        const storeManagementBtn = document.getElementById('storeManagementBtn');
        const closeStoreManagementPopup = document.getElementById('closeStoreManagementPopup');
        const closeStoreManagementBtn = document.getElementById('closeStoreManagementBtn');
        const storeList = document.getElementById('storeList');
        const saveCustomStoreBtn = document.getElementById('saveCustomStoreBtn');
        const storeAlreadyExists = document.getElementById('storeAlreadyExists');

        // NEW: Profit search elements
        const profitSearchInput = document.getElementById('profitSearchInput');
        const clearProfitSearchBtn = document.getElementById('clearProfitSearchBtn');

        // NEW: Calendar elements
        const calendarMonthYear = document.getElementById('calendarMonthYear');
        const calendarPrevMonth = document.getElementById('calendarPrevMonth');
        const calendarNextMonth = document.getElementById('calendarNextMonth');
        const calendarTabs = document.querySelectorAll('.calendar-tab');
        const calendarDayView = document.getElementById('calendarDayView');
        const calendarMonthView = document.getElementById('calendarMonthView');
        const calendarDaysGrid = document.getElementById('calendarDaysGrid');
        const calendarDayTotal = document.getElementById('calendarDayTotal');
        const dayBillPopup = document.getElementById('dayBillPopup');
        const dayBillPopupClose = document.getElementById('dayBillPopupClose');
        const dayBillPopupTitle = document.getElementById('dayBillPopupTitle');
        const dayBillPopupTotal = document.getElementById('dayBillPopupTotal');
        const dayBillPopupItems = document.getElementById('dayBillPopupItems');

        // Initialize app
        function init() {
            // Hide notification on page load
            hideNotification();
            
            loadItemsFromStorage();
            loadSuggestedProducts();
            loadLockedPrices();
            loadLockedSalePrices(); // NEW: Load locked sale prices
            loadCustomStores();
            loadThemePreference();
            renderItems();
            updateStoreFilter();
            updateStats();
            setupEventListeners();
            
            // Set default values for quick add
            quickItemStoreSelect.value = lastUsedStore;
            quickItemPrioritySelect.value = lastUsedPriority;
            
            // Set default sort to priority
            sortBySelect.value = 'priority';
            
            // Set default date to today
            selectedDate = new Date().toISOString().split('T')[0];
            selectedCalendarDate = selectedDate;
            
            // NEW: Update store dropdowns with custom stores
            updateStoreDropdowns();
            
            // NEW: Initialize calendar
            initCalendar();
            
            // Ensure Font Awesome icons are loaded
            ensureIconsLoaded();
        }

        // NEW: Initialize calendar
        function initCalendar() {
            renderCalendar();
            setupCalendarEventListeners();
        }

        // NEW: Setup calendar event listeners
        function setupCalendarEventListeners() {
            calendarPrevMonth.addEventListener('click', () => {
                currentCalendarMonth--;
                if (currentCalendarMonth < 0) {
                    currentCalendarMonth = 11;
                    currentCalendarYear--;
                }
                renderCalendar();
            });

            calendarNextMonth.addEventListener('click', () => {
                currentCalendarMonth++;
                if (currentCalendarMonth > 11) {
                    currentCalendarMonth = 0;
                    currentCalendarYear++;
                }
                renderCalendar();
            });

            calendarTabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const view = tab.dataset.calendarView;
                    switchCalendarView(view);
                });
            });

            dayBillPopupClose.addEventListener('click', closeDayBillPopup);
            dayBillPopup.addEventListener('click', (e) => {
                if (e.target === dayBillPopup) {
                    closeDayBillPopup();
                }
            });

            // ESC key to close popup
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && dayBillPopup.style.display === 'flex') {
                    closeDayBillPopup();
                }
            });
        }

        // NEW: Switch between DAY and MONTH views
        function switchCalendarView(view) {
            // Update active tab
            calendarTabs.forEach(tab => tab.classList.remove('active'));
            document.querySelector(`.calendar-tab[data-calendar-view="${view}"]`).classList.add('active');

            // Show/hide views
            if (view === 'day') {
                calendarDayView.classList.add('active');
                calendarMonthView.classList.remove('active');
            } else {
                calendarDayView.classList.remove('active');
                calendarMonthView.classList.add('active');
                renderMonthChart();
            }
        }

        // NEW: Render calendar for the current month
        function renderCalendar() {
            // Update month/year display
            const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'];
            calendarMonthYear.textContent = `${monthNames[currentCalendarMonth]} ${currentCalendarYear}`;

            // Get first day of month and number of days in month
            const firstDay = new Date(currentCalendarYear, currentCalendarMonth, 1).getDay();
            const daysInMonth = new Date(currentCalendarYear, currentCalendarMonth + 1, 0).getDate();

            // Get completed items for this month
            const completedItemsThisMonth = items.filter(item => {
                if (!item.completed || !item.completedDate) return false;
                
                const itemDate = new Date(item.completedDate);
                return itemDate.getFullYear() === currentCalendarYear && 
                       itemDate.getMonth() === currentCalendarMonth;
            });

            // Group completed items by date
            const itemsByDate = {};
            completedItemsThisMonth.forEach(item => {
                if (!itemsByDate[item.completedDate]) {
                    itemsByDate[item.completedDate] = [];
                }
                itemsByDate[item.completedDate].push(item);
            });

            // Calculate totals for each date
            const totalsByDate = {};
            Object.keys(itemsByDate).forEach(date => {
                totalsByDate[date] = itemsByDate[date].reduce((total, item) => {
                    return total + ((item.quantity || 1) * (item.price || 0));
                }, 0);
            });

            // Create calendar days grid
            let calendarHTML = '';

            // Add empty cells for days before the first day of the month
            for (let i = 0; i < firstDay; i++) {
                calendarHTML += `<div class="calendar-day empty"></div>`;
            }

            // Add days of the month
            const today = new Date().toISOString().split('T')[0];
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${currentCalendarYear}-${(currentCalendarMonth + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                const hasData = itemsByDate[dateStr] && itemsByDate[dateStr].length > 0;
                const isSelected = dateStr === selectedCalendarDate;
                const isToday = dateStr === today;
                
                let dayClass = 'calendar-day';
                if (hasData) dayClass += ' has-data';
                if (isSelected) dayClass += ' selected';
                if (isToday) dayClass += ' today';
                
                calendarHTML += `
                    <div class="${dayClass}" data-date="${dateStr}">
                        ${day}
                    </div>
                `;
            }

            calendarDaysGrid.innerHTML = calendarHTML;

            // Add event listeners to calendar days
            calendarDaysGrid.querySelectorAll('.calendar-day:not(.empty)').forEach(day => {
                day.addEventListener('click', () => {
                    const date = day.dataset.date;
                    if (date) {
                        // Update selected date
                        selectedCalendarDate = date;
                        selectedDate = date;
                        
                        // Update calendar day selection
                        calendarDaysGrid.querySelectorAll('.calendar-day').forEach(d => {
                            d.classList.remove('selected');
                        });
                        day.classList.add('selected');
                        
                        // Update total for selected day
                        updateCalendarDayTotal(date);
                        
                        // Render completed items for the selected date
                        renderCompletedItems();
                        
                        // Show day bill popup
                        showDayBillPopup(date);
                    }
                });
            });

            // Update total for currently selected day
            updateCalendarDayTotal(selectedCalendarDate);
        }

        // NEW: Update calendar day total
        function updateCalendarDayTotal(date) {
            const completedItemsForDate = items.filter(item => 
                item.completed && item.completedDate === date
            );
            
            const total = completedItemsForDate.reduce((sum, item) => {
                return sum + ((item.quantity || 1) * (item.price || 0));
            }, 0);
            
            calendarDayTotal.textContent = `Total: Rs ${total.toFixed(2)}`;
        }

        // NEW: Show day bill popup
        function showDayBillPopup(date) {
            const completedItemsForDate = items.filter(item => 
                item.completed && item.completedDate === date
            );
            
            // Format the date for display
            const dateObj = new Date(date);
            const formattedDate = dateObj.toLocaleDateString('en-US', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            // Calculate total
            const total = completedItemsForDate.reduce((sum, item) => {
                return sum + ((item.quantity || 1) * (item.price || 0));
            }, 0);
            
            // Update popup title and total
            dayBillPopupTitle.textContent = `Bill - ${formattedDate}`;
            dayBillPopupTotal.textContent = `Total: Rs ${total.toFixed(2)}`;
            
            // Render items
            if (completedItemsForDate.length === 0) {
                dayBillPopupItems.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <p class="empty-state-text">No completed items for this date.</p>
                    </div>
                `;
            } else {
                let itemsHTML = '';
                
                completedItemsForDate.forEach(item => {
                    const itemTotal = (item.quantity || 1) * (item.price || 0);
                    
                    itemsHTML += `
                        <div class="day-bill-popup-item">
                            <div class="day-bill-popup-item-details">
                                <div class="day-bill-popup-item-name">${item.name}</div>
                                <div class="day-bill-popup-item-meta">
                                    <span>Qty: ${item.quantity || 1}</span>
                                    <span>Price: Rs ${(item.price || 0).toFixed(2)}</span>
                                </div>
                            </div>
                            <div class="day-bill-popup-item-price">Rs ${itemTotal.toFixed(2)}</div>
                            <button class="day-bill-popup-item-remove" data-id="${item.id}" title="Remove item">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    `;
                });
                
                dayBillPopupItems.innerHTML = itemsHTML;
                
                // Add event listeners to remove buttons
                dayBillPopupItems.querySelectorAll('.day-bill-popup-item-remove').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const itemId = e.currentTarget.dataset.id;
                        removeCompletedItem(itemId);
                    });
                });
            }
            
            // Show the popup
            dayBillPopup.style.display = 'flex';
        }

        // NEW: Close day bill popup
        function closeDayBillPopup() {
            dayBillPopup.style.display = 'none';
        }

        // NEW: Remove completed item
        function removeCompletedItem(itemId) {
            if (confirm('Are you sure you want to remove this item from the completed list?')) {
                const index = items.findIndex(item => item.id === itemId);
                if (index !== -1) {
                    // Mark as active instead of deleting
                    items[index].completed = false;
                    items[index].completedDate = null;
                    
                    saveItemsToStorage();
                    
                    // Update UI
                    renderCalendar();
                    renderCompletedItems();
                    updateStats();
                    
                    // Close popup if no items left
                    const completedItemsForDate = items.filter(item => 
                        item.completed && item.completedDate === selectedCalendarDate
                    );
                    
                    if (completedItemsForDate.length === 0) {
                        closeDayBillPopup();
                    } else {
                        // Refresh popup
                        showDayBillPopup(selectedCalendarDate);
                    }
                    
                    showNotification('Item Restored', 'Item has been moved back to active items');
                }
            }
        }

        // NEW: Render month chart for the calendar
        function renderMonthChart() {
            const ctx = document.getElementById('monthChart').getContext('2d');
            
            // Define the 7 specific store names
            const specificStores = [
                "Babar Jafar Karyana Store",
                "Aslam Karyana Store", 
                "Waqas Rangwala",
                "Bakery",
                "Baloch Karyana Store",
                "Adrees Karyana Store",
                "Amir Karyana Store"
            ];
            
            // Calculate monthly data for pie chart - for the specific stores
            const storeData = {};
            const completedItems = items.filter(item => item.completed);
            
            // Initialize all specific stores with 0
            specificStores.forEach(store => {
                storeData[store] = 0;
            });
            
            completedItems.forEach(item => {
                if (item.completedDate) {
                    const date = new Date(item.completedDate);
                    const monthYear = `${date.getFullYear()}-${(date.getMonth() + 1).toString().padStart(2, '0')}`;
                    
                    // Only include items from current calendar month
                    const currentMonth = `${currentCalendarYear}-${(currentCalendarMonth + 1).toString().padStart(2, '0')}`;
                    
                    if (monthYear === currentMonth && specificStores.includes(item.store)) {
                        const itemTotal = (item.quantity || 1) * (item.price || 0);
                        storeData[item.store] += itemTotal;
                    }
                }
            });
            
            // Prepare chart data - only include stores with data
            const labels = [];
            const data = [];
            
            specificStores.forEach(store => {
                if (storeData[store] > 0) {
                    labels.push(store);
                    data.push(storeData[store]);
                }
            });
            
            // If no data, show empty state
            if (labels.length === 0) {
                const monthChartEl = document.getElementById('monthChart');
                if (monthChartEl) {
                    monthChartEl.style.display = 'none';
                }
                
                // Show empty state
                const monthView = document.querySelector('.calendar-month-view');
                if (monthView) {
                    monthView.innerHTML = `
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%;">
                            <div class="empty-state-icon" style="font-size: 2rem; margin-bottom: 1rem;">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            <p style="color: var(--text-secondary); text-align: center;">No data available for this month</p>
                        </div>
                    `;
                }
                return;
            }
            
            // Generate colors for each store
            const backgroundColors = [
                '#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981',
                '#3b82f6', '#ef4444'
            ].slice(0, labels.length);
            
            // Destroy existing chart if it exists
            if (monthChart) {
                monthChart.destroy();
            }
            
            // Create new pie chart with responsive settings
            monthChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColors,
                        borderColor: 'rgba(255, 255, 255, 0.8)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 1.5, // Keep the chart size consistent
                    layout: {
                        padding: {
                            top: 10,
                            bottom: 10,
                            left: 10,
                            right: 10
                        }
                    },
                    plugins: {
                        legend: {
                            display: false // We'll create a custom legend
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: Rs ${value.toFixed(2)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
            
            // Create custom legend
            createCustomLegend(labels, backgroundColors, data);
        }

        // Create custom legend for the pie chart
        function createCustomLegend(labels, colors, data) {
            const monthView = document.querySelector('.calendar-month-view');
            
            // Calculate total for percentages
            const total = data.reduce((a, b) => a + b, 0);
            
            // Create legend HTML
            let legendHTML = '<div class="month-chart-legend">';
            
            labels.forEach((label, index) => {
                const percentage = Math.round((data[index] / total) * 100);
                legendHTML += `
                    <div class="legend-item" title="${label} - Rs ${data[index].toFixed(2)} (${percentage}%)">
                        <span class="legend-color" style="background-color: ${colors[index]}"></span>
                        <span class="legend-text">${label}</span>
                    </div>
                `;
            });
            
            legendHTML += '</div>';
            
            // Add legend to the month view
            const existingLegend = monthView.querySelector('.month-chart-legend');
            if (existingLegend) {
                existingLegend.remove();
            }
            
            // Insert the legend after the chart container
            const chartWrapper = monthView.querySelector('.month-chart-wrapper');
            if (chartWrapper) {
                chartWrapper.insertAdjacentHTML('afterend', legendHTML);
            }
        }

        // Helper function to generate colors for pie chart
        function generateColors(count) {
            const colors = [
                '#6366f1', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981',
                '#3b82f6', '#ef4444', '#84cc16', '#f97316', '#06b6d4',
                '#a855f7', '#d946ef', '#0ea5e9', '#eab308', '#22c55e'
            ];
            
            // If we need more colors than available, generate random ones
            if (count > colors.length) {
                for (let i = colors.length; i < count; i++) {
                    colors.push(`hsl(${Math.floor(Math.random() * 360)}, 70%, 60%)`);
                }
            }
            
            return colors.slice(0, count);
        }

        // Ensure Font Awesome icons are loaded
        function ensureIconsLoaded() {
            // Check if Font Awesome is loaded
            if (!document.querySelector('link[href*="font-awesome"]')) {
                const fontAwesome = document.createElement('link');
                fontAwesome.rel = 'stylesheet';
                fontAwesome.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css';
                document.head.appendChild(fontAwesome);
            }
            
            // Fallback for dark mode icon if Font Awesome doesn't load
            setTimeout(() => {
                if (!window.FontAwesome) {
                    // Use inline SVG as fallback
                    updateThemeIcon();
                }
            }, 1000);
        }

        // Setup event listeners
        function setupEventListeners() {
            quickAddBtn.addEventListener('click', quickAddItem);
            floatingAddBtn.addEventListener('click', () => {
                quickItemNameInput.focus();
                quickItemNameInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
            });
            quickItemNameInput.addEventListener('keypress', handleKeyPress);
            quickItemNameInput.addEventListener('input', handleAutocomplete);
            quickItemNameInput.addEventListener('focus', handleAutocomplete);
            quickItemNameInput.addEventListener('blur', () => {
                setTimeout(hideAutocompleteSuggestions, 200);
            });
            quickItemStoreSelect.addEventListener('change', (e) => {
                if (e.target.value === 'Other') {
                    customStoreOption.style.display = 'flex';
                    customStoreInput.focus();
                } else {
                    customStoreOption.style.display = 'none';
                    storeAlreadyExists.style.display = 'none';
                    lastUsedStore = e.target.value;
                }
            });
            customStoreInput.addEventListener('input', (e) => {
                // NEW: Check for duplicate store names
                const storeName = e.target.value.trim();
                if (storeName) {
                    const isDuplicate = isDuplicateStore(storeName);
                    storeAlreadyExists.style.display = isDuplicate ? 'block' : 'none';
                    temporaryCustomStore = isDuplicate ? '' : storeName;
                } else {
                    storeAlreadyExists.style.display = 'none';
                    temporaryCustomStore = '';
                }
            });
            customStoreInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    if (!storeAlreadyExists.style.display || storeAlreadyExists.style.display === 'none') {
                        quickAddItem();
                    }
                }
            });
            filterStoreSelect.addEventListener('change', renderItems);
            filterPrioritySelect.addEventListener('change', renderItems);
            sortBySelect.addEventListener('change', renderItems);
            
            // Search functionality - FIXED: Debounced search for both active and completed tabs
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchQuery = e.target.value.toLowerCase();
                    renderItems();
                }, 300);
            });
            
            clearSearchBtn.addEventListener('click', () => {
                searchInput.value = '';
                searchQuery = '';
                renderItems();
            });
            
            notificationClose.addEventListener('click', hideNotification);
            
            // Cart icon event listener
            cartIcon.addEventListener('click', showCart);
            closeCartModal.addEventListener('click', () => {
                cartModal.style.display = 'none';
            });
            cartSelectAllCheckbox.addEventListener('change', toggleCartSelectAll);
            cartWhatsappShareBtn.addEventListener('click', shareCartBillViaWhatsApp);
            document.getElementById('cartShareListBtn').addEventListener('click', shareCartListViaWhatsApp);
            
            // Billing modal event listeners
            closeBillingModal.addEventListener('click', () => {
                billingModal.style.display = 'none';
            });
            billingWhatsappShareBtn.addEventListener('click', shareBillingViaWhatsApp);
            
            // Share list button event listener
            shareListBtn.addEventListener('click', () => showShareList());
            closeShareModal.addEventListener('click', () => {
                shareModal.style.display = 'none';
            });
            selectAllCheckbox.addEventListener('change', toggleSelectAll);
            shareWhatsappShareBtn.addEventListener('click', shareListViaWhatsApp);
            
            // Theme toggle event listener
            themeToggle.addEventListener('click', toggleTheme);
            
            // Tab event listeners - FIXED: Preserve scroll position and tab state
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // Store current scroll position before switching tabs
                    const currentTabContainer = document.getElementById(`${activeTab}-tab`);
                    const scrollPosition = currentTabContainer.scrollTop;
                    
                    // Remove active class from all tabs and contents
                    tabs.forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                    });
                    
                    // Add active class to clicked tab and corresponding content
                    tab.classList.add('active');
                    const tabId = tab.dataset.tab;
                    const newTabContainer = document.getElementById(`${tabId}-tab`);
                    newTabContainer.classList.add('active');
                    activeTab = tabId;
                    
                    // NEW: Clear temporary custom store when switching tabs
                    if (temporaryCustomStore && customStoreOption.style.display === 'flex') {
                        customStoreInput.value = '';
                        customStoreOption.style.display = 'none';
                        storeAlreadyExists.style.display = 'none';
                        quickItemStoreSelect.value = lastUsedStore;
                        temporaryCustomStore = '';
                    }
                    
                    // Re-render items for the active tab
                    if (tabId === 'billing') {
                        renderBilling();
                    } else if (tabId === 'profit') {
                        renderProfit();
                    } else if (tabId === 'completed') {
                        renderCompletedItems();
                        // NEW: Render calendar when switching to completed tab
                        renderCalendar();
                    } else {
                        renderItems();
                    }
                    
                    // Restore scroll position after a brief delay to allow rendering
                    setTimeout(() => {
                        newTabContainer.scrollTop = scrollPosition;
                    }, 50);
                });
            });
            
            // Priority modal event listeners
            priorityCloseBtn.addEventListener('click', closePriorityModal);
            priorityCancelBtn.addEventListener('click', closePriorityModal);
            prioritySaveBtn.addEventListener('click', savePriorityChange);
            
            priorityOptions.forEach(option => {
                option.addEventListener('click', () => {
                    // Remove selected class from all options
                    priorityOptions.forEach(opt => opt.classList.remove('selected'));
                    // Add selected class to clicked option
                    option.classList.add('selected');
                    // Store the selected priority
                    selectedPriority = option.dataset.priority;
                });
            });
            
            // Move modal event listeners
            moveCloseBtn.addEventListener('click', closeMoveModal);
            moveCancelBtn.addEventListener('click', closeMoveModal);
            moveSaveBtn.addEventListener('click', saveMoveItem);
            moveToStore.addEventListener('change', (e) => {
                if (e.target.value === 'Other') {
                    moveCustomStoreOption.style.display = 'block';
                    moveCustomStore.focus();
                } else {
                    moveCustomStoreOption.style.display = 'none';
                }
            });
            
            // Close modal when clicking outside
            cartModal.addEventListener('click', (e) => {
                if (e.target === cartModal) {
                    cartModal.style.display = 'none';
                }
            });
            
            billingModal.addEventListener('click', (e) => {
                if (e.target === billingModal) {
                    billingModal.style.display = 'none';
                }
            });
            
            shareModal.addEventListener('click', (e) => {
                if (e.target === shareModal) {
                    shareModal.style.display = 'none';
                }
            });
            
            priorityModal.addEventListener('click', (e) => {
                if (e.target === priorityModal) {
                    closePriorityModal();
                }
            });
            
            moveModal.addEventListener('click', (e) => {
                if (e.target === moveModal) {
                    closeMoveModal();
                }
            });

            // NEW: Store management event listeners
            storeManagementBtn.addEventListener('click', openStoreManagement);
            closeStoreManagementPopup.addEventListener('click', closeStoreManagement);
            closeStoreManagementBtn.addEventListener('click', closeStoreManagement);
            saveCustomStoreBtn.addEventListener('click', saveCustomStore);

            // NEW: Profit search event listeners
            profitSearchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    filterProfitItems(e.target.value.toLowerCase());
                }, 300);
            });
            
            clearProfitSearchBtn.addEventListener('click', () => {
                profitSearchInput.value = '';
                filterProfitItems('');
            });

            // Listen for resize to update suggestion position if needed
            window.addEventListener('resize', () => {
                if (document.querySelector('.autocomplete-suggestions.visible')) {
                    handleAutocomplete({target: quickItemNameInput});
                }
            });

            // NEW: Use event delegation for dynamically created elements
            document.addEventListener('click', (e) => {
                // Handle checkbox toggles with event delegation - FIXED: Immediate completion toggle
                if (e.target.matches('.item-checkbox input[type="checkbox"]')) {
                    const itemId = e.target.dataset.id;
                    toggleItemCompletion(itemId);
                }
                
                // Handle delete buttons with event delegation
                if (e.target.closest('.delete-btn')) {
                    const itemId = e.target.closest('.delete-btn').dataset.id;
                    deleteItem(itemId);
                }
                
                // Handle move buttons with event delegation
                if (e.target.closest('.move-btn')) {
                    const itemId = e.target.closest('.move-btn').dataset.id;
                    openMoveModal(itemId);
                }
                
                // Handle priority clicks with event delegation
                if (e.target.closest('.item-priority')) {
                    const itemId = e.target.closest('.item-priority').dataset.id;
                    openPriorityModal(itemId);
                }
            });

            // NEW: ESC key to close modals
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (dayBillPopup.style.display === 'flex') {
                        closeDayBillPopup();
                    } else if (storeManagementPopup.style.display === 'flex') {
                        closeStoreManagement();
                    } else if (priorityModal.style.display === 'flex') {
                        closePriorityModal();
                    } else if (moveModal.style.display === 'flex') {
                        closeMoveModal();
                    } else if (cartModal.style.display === 'flex') {
                        cartModal.style.display = 'none';
                    } else if (billingModal.style.display === 'flex') {
                        billingModal.style.display = 'none';
                    } else if (shareModal.style.display === 'flex') {
                        shareModal.style.display = 'none';
                    }
                }
            });
        }

        // Handle key press for suggestions
        function handleKeyPress(e) {
            if (e.key === 'Enter') {
                if (selectedSuggestionIndex >= 0) {
                    e.preventDefault();
                    const suggestions = document.querySelectorAll('.autocomplete-suggestion');
                    const selected = suggestions[selectedSuggestionIndex];
                    selectSuggestion(selected.querySelector('.suggestion-name').textContent, e.target);
                } else {
                    quickAddItem();
                }
            } else if (e.key === 'Tab') {
                if (selectedSuggestionIndex >= 0) {
                    e.preventDefault();
                    const suggestions = document.querySelectorAll('.autocomplete-suggestion');
                    const selected = suggestions[selectedSuggestionIndex];
                    selectSuggestion(selected.querySelector('.suggestion-name').textContent, e.target);
                }
            } else if (e.key === 'ArrowDown') {
                e.preventDefault();
                navigateSuggestions(1);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                navigateSuggestions(-1);
            }
        }

        // Autocomplete functionality with absolute positioning
        function handleAutocomplete(e) {
            const query = e.target.value.toLowerCase().trim();
            
            if (query.length === 0) {
                hideAutocompleteSuggestions();
                return;
            }
            
            // Filter suggestions
            let filteredSuggestions = suggestedProducts.filter(product => 
                product.name.toLowerCase().includes(query)
            );
            
            // Sort filtered suggestions
            filteredSuggestions.sort((a, b) => {
                const aNameLower = a.name.toLowerCase();
                const bNameLower = b.name.toLowerCase();
                
                // Priority 1: Exact locked-price matches
                const aLocked = !!lockedPrices[aNameLower];
                const bLocked = !!lockedPrices[bNameLower];
                if (aLocked !== bLocked) return bLocked - aLocked; // false - true = 1, true first
                
                // Priority 2: Starts with query
                const aStarts = aNameLower.startsWith(query);
                const bStarts = bNameLower.startsWith(query);
                if (aStarts !== bStarts) return bStarts - aStarts;
                
                // Priority 3: Frequency desc
                if (a.frequency !== b.frequency) return b.frequency - a.frequency;
                
                // Priority 4: Last used desc
                return b.lastUsedAt - a.lastUsedAt;
            });
            
            if (filteredSuggestions.length > 0) {
                showAutocompleteSuggestions(filteredSuggestions, e.target);
            } else {
                hideAutocompleteSuggestions();
            }
        }

        function showAutocompleteSuggestions(suggestions, inputElement) {
            // Remove existing suggestions
            hideAutocompleteSuggestions();
            
            // Create suggestions container
            const suggestionsContainer = document.createElement('div');
            suggestionsContainer.className = 'autocomplete-suggestions';
            suggestionsContainer.id = 'autocompleteSuggestions';
            suggestionsContainer.setAttribute('role', 'listbox');
            suggestionsContainer.setAttribute('aria-label', 'Product suggestions');
            
            // Add suggestion items
            suggestions.forEach((suggestion, index) => {
                const suggestionItem = document.createElement('div');
                suggestionItem.className = 'autocomplete-suggestion';
                suggestionItem.dataset.index = index;
                suggestionItem.setAttribute('role', 'option');
                
                // Create name and price elements
                const nameElement = document.createElement('span');
                nameElement.className = 'suggestion-name';
                nameElement.textContent = suggestion.name;
                
                // Check if this product has a locked price
                const lowerName = suggestion.name.toLowerCase();
                const hasBuyPrice = lockedPrices[lowerName];
                const hasSalePrice = lockedSalePrices[lowerName];
                
                if (hasBuyPrice || hasSalePrice) {
                    const priceElement = document.createElement('span');
                    priceElement.className = 'suggestion-price';
                    
                    if (hasBuyPrice && hasSalePrice) {
                        priceElement.textContent = `Buy: Rs ${lockedPrices[lowerName].toFixed(2)} | Sale: Rs ${lockedSalePrices[lowerName].toFixed(2)}`;
                    } else if (hasBuyPrice) {
                        priceElement.textContent = `Buy: Rs ${lockedPrices[lowerName].toFixed(2)}`;
                    } else if (hasSalePrice) {
                        priceElement.textContent = `Sale: Rs ${lockedSalePrices[lowerName].toFixed(2)}`;
                    }
                    
                    suggestionItem.appendChild(nameElement);
                    suggestionItem.appendChild(priceElement);
                } else {
                    suggestionItem.appendChild(nameElement);
                }
                
                suggestionItem.addEventListener('click', () => {
                    selectSuggestion(suggestion.name, inputElement);
                });
                
                suggestionItem.addEventListener('mouseenter', () => {
                    document.querySelectorAll('.autocomplete-suggestion').forEach(item => {
                        item.classList.remove('selected');
                        item.setAttribute('aria-selected', 'false');
                    });
                    suggestionItem.classList.add('selected');
                    suggestionItem.setAttribute('aria-selected', 'true');
                    selectedSuggestionIndex = index;
                });
                
                suggestionsContainer.appendChild(suggestionItem);
            });
            
            // Add to quick-input container
            quickInputContainer.appendChild(suggestionsContainer);
            suggestionsContainer.style.width = `${inputElement.offsetWidth}px`;
            
            // Make visible with animation
            setTimeout(() => {
                suggestionsContainer.classList.add('visible');
            }, 10);
            
            selectedSuggestionIndex = -1;
        }

        function hideAutocompleteSuggestions() {
            const suggestionsContainer = document.getElementById('autocompleteSuggestions');
            if (suggestionsContainer) {
                suggestionsContainer.classList.remove('visible');
                setTimeout(() => {
                    if (suggestionsContainer.parentNode) {
                        suggestionsContainer.parentNode.removeChild(suggestionsContainer);
                    }
                }, 200);
            }
            selectedSuggestionIndex = -1;
        }

        function selectSuggestion(productName, inputElement) {
            inputElement.value = productName;
            hideAutocompleteSuggestions();
            inputElement.focus();
        }

        function navigateSuggestions(direction) {
            const suggestions = document.querySelectorAll('.autocomplete-suggestion');
            if (suggestions.length === 0) return;
            
            // Remove previous selection
            if (selectedSuggestionIndex >= 0) {
                suggestions[selectedSuggestionIndex].classList.remove('selected');
                suggestions[selectedSuggestionIndex].setAttribute('aria-selected', 'false');
            }
            
            // Calculate new index
            selectedSuggestionIndex += direction;
            if (selectedSuggestionIndex < 0) {
                selectedSuggestionIndex = suggestions.length - 1;
            } else if (selectedSuggestionIndex >= suggestions.length) {
                selectedSuggestionIndex = 0;
            }
            
            // Apply new selection
            suggestions[selectedSuggestionIndex].classList.add('selected');
            suggestions[selectedSuggestionIndex].setAttribute('aria-selected', 'true');
            quickItemNameInput.value = suggestions[selectedSuggestionIndex].querySelector('.suggestion-name').textContent;
            // Scroll into view if needed
            suggestions[selectedSuggestionIndex].scrollIntoView({block: 'nearest'});
        }

        // Learn product names from completed items
        function learnProductName(productName) {
            if (!productName || productName.trim().length === 0) return;
            
            const name = productName.trim();
            const normalizedName = name.toLowerCase();
            
            // Find if exists
            const existingIndex = suggestedProducts.findIndex(p => p.name.toLowerCase() === normalizedName);
            
            const now = Date.now();
            if (existingIndex >= 0) {
                suggestedProducts[existingIndex].frequency++;
                suggestedProducts[existingIndex].lastUsedAt = now;
            } else {
                suggestedProducts.push({name, frequency: 1, lastUsedAt: now});
                // Keep only last 50
                if (suggestions.length > 50) {
                    suggestedProducts.shift();
                }
            }
            
            // Save to localStorage
            saveSuggestedProducts();
        }

        // Save and load suggested products
        function saveSuggestedProducts() {
            localStorage.setItem('swiftCartSuggestedProducts', JSON.stringify(suggestedProducts));
        }

        function loadSuggestedProducts() {
            const saved = localStorage.getItem('swiftCartSuggestedProducts');
            if (saved) {
                suggestedProducts = JSON.parse(saved);
            }
        }

        // NEW: Save and load custom stores
        function saveCustomStores() {
            localStorage.setItem('swiftCartCustomStores', JSON.stringify(customStores));
        }

        function loadCustomStores() {
            const saved = localStorage.getItem('swiftCartCustomStores');
            if (saved) {
                customStores = JSON.parse(saved);
                // NEW: Update store dropdowns with loaded custom stores
                updateStoreDropdowns();
            }
        }

        // Save and load locked prices
        function saveLockedPrices() {
            localStorage.setItem('swiftCartLockedPrices', JSON.stringify(lockedPrices));
        }

        function loadLockedPrices() {
            const saved = localStorage.getItem('swiftCartLockedPrices');
            if (saved) {
                lockedPrices = JSON.parse(saved);
            }
        }

        // NEW: Save and load locked sale prices
        function saveLockedSalePrices() {
            localStorage.setItem('swiftCartLockedSalePrices', JSON.stringify(lockedSalePrices));
        }

        function loadLockedSalePrices() {
            const saved = localStorage.getItem('swiftCartLockedSalePrices');
            if (saved) {
                lockedSalePrices = JSON.parse(saved);
            }
        }

        // Update locked price for a product
        function updateLockedPrice(productName, price) {
            if (price > 0) {
                lockedPrices[productName.toLowerCase()] = price;
                saveLockedPrices();
            }
        }

        // NEW: Update locked sale price for a product
        function updateLockedSalePrice(productName, price) {
            if (price > 0) {
                lockedSalePrices[productName.toLowerCase()] = price;
                saveLockedSalePrices();
            }
        }

        // Get locked price for a product
        function getLockedPrice(productName) {
            return lockedPrices[productName.toLowerCase()] || 0;
        }

        // NEW: Get locked sale price for a product
        function getLockedSalePrice(productName) {
            return lockedSalePrices[productName.toLowerCase()] || 0;
        }

        // Theme toggle functions
        function toggleTheme() {
            isDarkMode = !isDarkMode;
            applyTheme();
            saveThemePreference();
            
            // Show notification for theme change
            if (isDarkMode) {
                showNotification('Dark Mode', 'Dark mode has been enabled', false, 'info');
            } else {
                showNotification('Light Mode', 'Light mode has been enabled', false, 'info');
            }
        }

        function updateThemeIcon() {
            if (isDarkMode) {
                // Show moon icon for dark mode
                themeIcon.className = 'fas fa-moon';
            } else {
                // Show sun icon for light mode
                themeIcon.className = 'fas fa-sun';
            }
        }

        function applyTheme() {
            if (isDarkMode) {
                document.body.classList.add('dark-mode');
            } else {
                document.body.classList.remove('dark-mode');
            }
            updateThemeIcon();
        }

        function saveThemePreference() {
            localStorage.setItem('swiftCartTheme', isDarkMode ? 'dark' : 'light');
        }

        function loadThemePreference() {
            const savedTheme = localStorage.getItem('swiftCartTheme');
            isDarkMode = savedTheme === 'dark';
            applyTheme();
        }

        // Update stats
        function updateStats() {
            const activeItems = items.filter(item => !item.completed);
            const completedItems = items.filter(item => item.completed);
            const stores = [...new Set(items.map(item => item.store))];
            
            activeCount.textContent = activeItems.length;
            completedCount.textContent = completedItems.length;
            storeCount.textContent = stores.length;
        }

        // Show notification - Enhanced
        function showNotification(title, message, isError = false, type = 'success') {
            notificationTitle.textContent = title;
            notificationMessage.textContent = message;
            
            // Remove all notification classes
            notification.classList.remove('error', 'success', 'info');
            
            if (isError) {
                notification.classList.add('error');
                notificationIcon.innerHTML = '<i class="fas fa-exclamation-circle"></i>';
            } else if (type === 'info') {
                notification.classList.add('info');
                notificationIcon.innerHTML = '<i class="fas fa-info-circle"></i>';
            } else {
                notification.classList.add('success');
                notificationIcon.innerHTML = '<i class="fas fa-check-circle"></i>';
            }
            
            notification.style.display = 'flex';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                hideNotification();
            }, 5000);
        }

        function hideNotification() {
            notification.style.display = 'none';
        }

        // Check for duplicate items
        function isDuplicateItem(name, store) {
            return items.some(item => 
                item.name.toLowerCase() === name.toLowerCase() && 
                item.store === store && 
                !item.completed
            );
        }

        // Quick add item - UPDATED: Now loads both buy and sale prices
        function quickAddItem() {
            const name = quickItemNameInput.value.trim();
            let store = quickItemStoreSelect.value;
            
            // NEW: Handle temporary custom store
            if (store === 'Other') {
                if (temporaryCustomStore) {
                    store = temporaryCustomStore;
                } else {
                    store = customStoreInput.value.trim() || 'General';
                }
            }
            
            const priority = quickItemPrioritySelect.value;
            
            if (!name) {
                quickItemNameInput.focus();
                return;
            }
            
            // Check for duplicate
            if (isDuplicateItem(name, store)) {
                showNotification('Duplicate Item', `"${name}" has already been added to ${store}`, true);
                quickItemNameInput.focus();
                return;
            }
            
            // Remember last used values
            lastUsedStore = store;
            lastUsedPriority = priority;
            
            // Check if this product has locked prices
            const lockedPrice = getLockedPrice(name);
            const lockedSalePrice = getLockedSalePrice(name);
            
            // Add new item with default values
            const newItem = {
                id: Date.now().toString(),
                name,
                store,
                priority,
                completed: false,
                quantity: 1,
                price: lockedPrice || 0,
                selling_price: lockedSalePrice || 0,
                priceLocked: lockedPrice > 0,
                salePriceLocked: lockedSalePrice > 0,
                completedDate: null
            };
            items.push(newItem);
            
            saveItemsToStorage();
            renderItems();
            updateStoreFilter();
            updateStats();
            
            // Reset form but keep store and priority for next item
            quickItemNameInput.value = '';
            quickItemStoreSelect.value = lastUsedStore;
            customStoreInput.value = '';
            customStoreOption.style.display = 'none';
            storeAlreadyExists.style.display = 'none';
            quickItemPrioritySelect.value = lastUsedPriority;
            quickItemNameInput.focus();
            
            // Hide autocomplete suggestions
            hideAutocompleteSuggestions();
            
            // Clear temporary custom store
            temporaryCustomStore = '';
            
            // Show success notification
            showNotification('Item Added', `"${name}" added successfully!`);
        }

        // Delete item
        function deleteItem(id) {
            if (confirm('Are you sure you want to delete this item?')) {
                items = items.filter(item => item.id !== id);
                saveItemsToStorage();
                renderItems();
                updateStoreFilter();
                updateStats();
            }
        }

        // FIXED: Toggle item completion - Immediate completion without delay using DOM updates
        function toggleItemCompletion(id) {
            const index = items.findIndex(item => item.id === id);
            const item = items[index];
            
            // Store current scroll position
            const currentTabContainer = document.getElementById(`${activeTab}-tab`);
            const scrollPosition = currentTabContainer.scrollTop;
            
            if (item.completed) {
                // Mark as active
                item.completed = false;
                item.completedDate = null;
            } else {
                // Mark as completed with today's date
                item.completed = true;
                item.completedDate = new Date().toISOString().split('T')[0];
                learnProductName(item.name);
                
                // Save the locked prices if they exist
                if (item.priceLocked && item.price > 0) {
                    updateLockedPrice(item.name, item.price);
                }
                if (item.salePriceLocked && item.selling_price > 0) {
                    updateLockedSalePrice(item.name, item.selling_price);
                }
            }
            
            saveItemsToStorage();
            
            // Update UI without full re-render - use DOM manipulation
            updateItemCardInDOM(item);
            updateStats();
            
            // If on profit tab, refresh profit data
            if (activeTab === 'profit') {
                renderProfit();
            }
            
            // If on completed tab, refresh completed items
            if (activeTab === 'completed') {
                renderCompletedItems();
                // NEW: Update calendar when items are completed
                renderCalendar();
            }
            
            // Restore scroll position
            currentTabContainer.scrollTop = scrollPosition;
        }

        // NEW: Update individual item card in DOM without full re-render
        function updateItemCardInDOM(item) {
            const itemCard = document.querySelector(`[data-id="${item.id}"]`)?.closest('.item-card');
            if (!itemCard) return;
            
            // Update checkbox state
            const checkbox = itemCard.querySelector('input[type="checkbox"]');
            if (checkbox) {
                checkbox.checked = item.completed;
                checkbox.nextElementSibling.textContent = `Mark as ${item.completed ? 'active' : 'completed'}`;
            }
            
            // Update card appearance
            if (item.completed) {
                itemCard.classList.add('completed');
                itemCard.querySelector('.item-name').style.textDecoration = 'line-through';
                itemCard.style.opacity = '0.8';
            } else {
                itemCard.classList.remove('completed');
                itemCard.querySelector('.item-name').style.textDecoration = 'none';
                itemCard.style.opacity = '1';
            }
        }

        // Open priority modal for an item
        function openPriorityModal(id) {
            currentEditingItemId = id;
            const item = items.find(item => item.id === id);
            
            // Set current priority as selected
            selectedPriority = item.priority;
            
            // Update UI to show current priority as selected
            priorityOptions.forEach(option => {
                option.classList.remove('selected');
                if (option.dataset.priority === selectedPriority) {
                    option.classList.add('selected');
                }
            });
            
            // Show modal
            priorityModal.style.display = 'flex';
        }

        // Close priority modal
        function closePriorityModal() {
            priorityModal.style.display = 'none';
            currentEditingItemId = null;
            selectedPriority = null;
        }

        // Save priority change
        function savePriorityChange() {
            if (!currentEditingItemId || !selectedPriority) return;
            
            const index = items.findIndex(item => item.id === currentEditingItemId);
            items[index].priority = selectedPriority;
            
            saveItemsToStorage();
            renderItems();
            closePriorityModal();
        }

        // Open move modal for an item
        function openMoveModal(id) {
            currentMovingItemId = id;
            const item = items.find(item => item.id === id);
            
            // Set item details
            moveItemName.value = item.name;
            moveFromStore.value = item.store;
            
            // Reset destination store
            moveToStore.value = '';
            moveCustomStore.value = '';
            moveCustomStoreOption.style.display = 'none';
            
            // Show modal
            moveModal.style.display = 'flex';
        }

        // Close move modal
        function closeMoveModal() {
            moveModal.style.display = 'none';
            currentMovingItemId = null;
        }

        // Save move item
        function saveMoveItem() {
            if (!currentMovingItemId) return;
            
            let destinationStore = moveToStore.value;
            
            if (destinationStore === 'Other') {
                destinationStore = moveCustomStore.value.trim() || 'General';
            }
            
            if (!destinationStore) {
                alert('Please select a destination store');
                return;
            }
            
            // Get item details
            const item = items.find(item => item.id === currentMovingItemId);
            
            // Check for duplicate items in the destination store
            if (isDuplicateItem(item.name, destinationStore)) {
                showNotification('Duplicate Item', `"${item.name}" already exists in ${destinationStore}`, true);
                return;
            }
            
            // Update item store
            const index = items.findIndex(item => item.id === currentMovingItemId);
            items[index].store = destinationStore;
            
            saveItemsToStorage();
            renderItems();
            updateStoreFilter();
            closeMoveModal();
            
            // Show success notification
            showNotification('Item Moved', `Item moved to ${destinationStore} successfully!`);
        }

        // Filter and sort items - FIXED: Search works on both Active and Completed tabs
        function getFilteredAndSortedItems() {
            let filteredItems = [...items];
            
            // Filter by completion status based on active tab
            if (activeTab === 'active') {
                filteredItems = filteredItems.filter(item => !item.completed);
            } else if (activeTab === 'completed') {
                // For completed tab, we filter by selected date
                filteredItems = filteredItems.filter(item => 
                    item.completed && item.completedDate === selectedCalendarDate
                );
            } else {
                filteredItems = filteredItems.filter(item => item.completed);
            }
            
            // Filter by search query - works on both active and completed tabs
            if (searchQuery) {
                filteredItems = filteredItems.filter(item => 
                    item.name.toLowerCase().includes(searchQuery)
                );
            }
            
            // Filter by store
            const storeFilter = filterStoreSelect.value;
            if (storeFilter !== 'all') {
                filteredItems = filteredItems.filter(item => item.store === storeFilter);
            }
            
            // Filter by priority
            const priorityFilter = filterPrioritySelect.value;
            if (priorityFilter !== 'all') {
                filteredItems = filteredItems.filter(item => item.priority === priorityFilter);
            }
            
            // Sort items by priority by default
            filteredItems.sort((a, b) => {
                const priorityOrder = { high: 0, medium: 1, low: 2 };
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            });
            
            // Then apply additional sorting if selected
            const sortBy = sortBySelect.value;
            if (sortBy === 'store') {
                filteredItems.sort((a, b) => a.store.localeCompare(b.store));
            } else if (sortBy === 'name') {
                filteredItems.sort((a, b) => a.name.localeCompare(b.name));
            }
            
            return filteredItems;
        }

        // Group items by store
        function groupItemsByStore(items) {
            const grouped = {};
            
            items.forEach(item => {
                if (!grouped[item.store]) {
                    grouped[item.store] = [];
                }
                grouped[item.store].push(item);
            });
            
            return grouped;
        }

        // Render items for active and completed tabs
        function renderItems() {
            const filteredItems = getFilteredAndSortedItems();
            const container = activeTab === 'active' ? activeItemsContainer : completedItemsContainer;
            
            if (filteredItems.length === 0) {
                if (activeTab === 'active') {
                    if (searchQuery) {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">
                                    <i class="fas fa-search"></i>
                                </div>
                                <p class="empty-state-text">No items found matching "${searchQuery}"</p>
                        </div>
                        `;
                    } else {
                        container.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-state-icon">
                                    <i class="fas fa-shopping-basket"></i>
                                </div>
                                <p class="empty-state-text">No active items. Add your first shopping item!</p>
                            </div>
                        `;
                    }
                } else {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-check-circle"></i>
                            </div>
                            <p class="empty-state-text">No completed items for this date.</p>
                        </div>
                    `;
                }
                return;
            }
            
            const groupedItems = groupItemsByStore(filteredItems);
            let html = '';
            
            for (const store in groupedItems) {
                html += `
                    <div class="store-section">
                        <div class="store-header">
                            <h2 class="store-name">${store}</h2>
                            <span class="store-count">${groupedItems[store].length}</span>
                        </div>
                        <div class="items-container">
                `;
                
                groupedItems[store].forEach(item => {
                    const priorityClass = `priority-${item.priority}`;
                    const completedClass = item.completed ? 'completed' : '';
                    const checkedAttr = item.completed ? 'checked' : '';
                    
                    html += `
                        <div class="item-card ${completedClass}" data-id="${item.id}">
                            <div class="priority-indicator ${priorityClass}"></div>
                            <div class="item-header">
                                <h3 class="item-name">${item.name}</h3>
                                <div class="item-actions">
                                    <button class="action-btn move-btn" data-id="${item.id}" title="Move to another store">
                                        <i class="fas fa-exchange-alt"></i>
                                    </button>
                                    <button class="action-btn delete-btn" data-id="${item.id}" title="Delete item">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="item-details">
                                <div class="item-store">${item.store}</div>
                                <div class="item-priority" data-id="${item.id}" title="Click to change priority">
                                    <span class="priority-dot ${priorityClass}"></span>
                                    ${item.priority.charAt(0).toUpperCase() + item.priority.slice(1)} Priority
                                </div>
                            </div>
                            <div class="item-checkbox">
                                <input type="checkbox" id="check-${item.id}" ${checkedAttr} data-id="${item.id}">
                                <label for="check-${item.id}">Mark as ${item.completed ? 'active' : 'completed'}</label>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            container.innerHTML = html;
        }

        // Render completed items with billing summary
        function renderCompletedItems() {
            const filteredItems = items.filter(item => 
                item.completed && item.completedDate === selectedCalendarDate
            );
            
            if (filteredItems.length === 0) {
                completedItemsContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <p class="empty-state-text">No completed items for this date.</p>
                    </div>
                `;
                completedBilling.style.display = 'none';
                return;
            }
            
            const groupedItems = groupItemsByStore(filteredItems);
            let html = '';
            
            for (const store in groupedItems) {
                html += `
                    <div class="store-section">
                        <div class="store-header">
                            <h2 class="store-name">${store}</h2>
                            <span class="store-count">${groupedItems[store].length}</span>
                        </div>
                        <div class="items-container">
                `;
                
                groupedItems[store].forEach(item => {
                    const priorityClass = `priority-${item.priority}`;
                    const completedClass = item.completed ? 'completed' : '';
                    const checkedAttr = item.completed ? 'checked' : '';
                    
                    html += `
                        <div class="item-card ${completedClass}" data-id="${item.id}">
                            <div class="priority-indicator ${priorityClass}"></div>
                            <div class="item-header">
                                <h3 class="item-name">${item.name}</h3>
                                <div class="item-actions">
                                    <button class="action-btn move-btn" data-id="${item.id}" title="Move to another store">
                                        <i class="fas fa-exchange-alt"></i>
                                    </button>
                                    <button class="action-btn delete-btn" data-id="${item.id}" title="Delete item">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="item-details">
                                <div class="item-store">${item.store}</div>
                                <div class="item-priority" data-id="${item.id}" title="Click to change priority">
                                    <span class="priority-dot ${priorityClass}"></span>
                                    ${item.priority.charAt(0).toUpperCase() + item.priority.slice(1)} Priority
                                </div>
                            </div>
                            <div class="item-checkbox">
                                <input type="checkbox" id="check-${item.id}" ${checkedAttr} data-id="${item.id}">
                                <label for="check-${item.id}">Mark as active</label>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            }
            
            completedItemsContainer.innerHTML = html;
            
            // Render billing summary
            renderBillingSummary(filteredItems);
        }

        // UPDATED: Render billing summary for completed items - Fixed duplicate total
        function renderBillingSummary(completedItems) {
            let billingHtml = '';
            let grandTotal = 0;
            
            // Group by store for billing
            const groupedItems = groupItemsByStore(completedItems);
            
            // Process each store
            for (const store in groupedItems) {
                let storeTotal = 0;
                let storeItemsHtml = '';
                
                // Process each item in the store
                groupedItems[store].forEach(item => {
                    const itemTotal = (item.quantity || 1) * (item.price || 0);
                    storeTotal += itemTotal;
                    
                    // Create item HTML in the format similar to the image
                    storeItemsHtml += `
                        <div class="completed-billing-item">
                            <div class="completed-billing-item-details">
                                <div class="completed-billing-item-name">${item.name}</div>
                                <div class="completed-billing-item-quantity">Qty: ${item.quantity || 1} × Rs ${(item.price || 0).toFixed(2)}</div>
                            </div>
                            <div class="completed-billing-item-price">
                                <div class="completed-billing-item-price-line">Rs ${(item.price || 0).toFixed(2)}</div>
                                <div class="completed-billing-item-total">Rs ${itemTotal.toFixed(2)}</div>
                            </div>
                        </div>
                    `;
                });
                
                // Add store section to billing HTML
                billingHtml += `
                    <div class="completed-billing-store">
                        <div class="completed-billing-store-header">
                            <div class="completed-billing-store-name">${store}</div>
                            <div class="completed-billing-store-total">Total: Rs ${storeTotal.toFixed(2)}</div>
                        </div>
                        <div class="completed-billing-items">
                            ${storeItemsHtml}
                        </div>
                    </div>
                `;
                
                grandTotal += storeTotal;
            }
            
            // Update the billing containers
            completedBillingStores.innerHTML = billingHtml;
            completedGrandTotal.textContent = `Rs ${grandTotal.toFixed(2)}`;
            // Removed the duplicate total from header
            
            // Show the billing section
            completedBilling.style.display = 'block';
        }

        // Render billing
        function renderBilling() {
            const activeItems = items.filter(item => !item.completed);
            
            if (activeItems.length === 0) {
                billingContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <p class="empty-state-text">No items to bill. Add items to your cart first!</p>
                    </div>
                `;
                return;
            }
            
            // Sort items by priority
            activeItems.sort((a, b) => {
                const priorityOrder = { high: 0, medium: 1, low: 2 };
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            });
            
            // Group items by store
            const groupedItems = groupItemsByStore(activeItems);
            
            let html = '';
            let grandTotal = 0;
            
            for (const store in groupedItems) {
                let storeSubtotal = 0;
                
                html += `
                    <div class="billing-store-section">
                        <div class="billing-store-header">
                            <div class="billing-store-name">${store}</div>
                            <div class="billing-store-subtotal" id="store-subtotal-${store}">Rs 0.00</div>
                        </div>
                        <div class="billing-store-items">
                `;
                
                groupedItems[store].forEach(item => {
                    const itemTotal = (item.quantity || 1) * (item.price || 0);
                    storeSubtotal += itemTotal;
                    grandTotal += itemTotal;
                    
                    html += `
                        <div class="billing-item">
                            <div class="billing-item-name">${item.name}</div>
                            <div class="billing-item-quantity">Qty: ${item.quantity || 1}</div>
                            <div class="billing-item-price">Rs ${(item.price || 0).toFixed(2)}</div>
                            <div class="billing-item-total">Rs ${itemTotal.toFixed(2)}</div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
                
                // Update store subtotal after rendering
                setTimeout(() => {
                    const storeSubtotalEl = document.getElementById(`store-subtotal-${store}`);
                    if (storeSubtotalEl) {
                        storeSubtotalEl.textContent = `Rs ${storeSubtotal.toFixed(2)}`;
                    }
                }, 0);
            }
            
            billingContainer.innerHTML = html;
            grandTotalAmount.textContent = `Rs ${grandTotal.toFixed(2)}`;
        }

        // Render profit & analysis
        function renderProfit() {
            const completedItems = items.filter(item => item.completed);
            
            // Update summary cards
            totalRecords.textContent = items.length;
            completedItemsEl.textContent = completedItems.length;
            
            // Calculate financials
            let totalExp = 0;
            let computedSales = 0;
            let totalProf = 0;
            
            completedItems.forEach(item => {
                const qty = item.quantity || 1;
                const buying = item.price || 0;
                const selling = item.selling_price || 0;
                
                totalExp += buying * qty;
                computedSales += selling * qty;
                totalProf += (selling - buying) * qty;
            });

            const effectiveSales = computedSales;
            const effectiveProf = effectiveSales - totalExp;
            
            totalExpenditure.textContent = `Rs ${totalExp.toFixed(2)}`;
            totalSales.textContent = `Rs ${effectiveSales.toFixed(2)}`;
            totalProfit.textContent = `Rs ${effectiveProf.toFixed(2)}`;
            
            // Update profit card styling
            if (effectiveProf >= 0) {
                profitSummaryCard.className = 'summary-card profit';
                totalProfit.className = 'summary-card-value profit';
            } else {
                profitSummaryCard.className = 'summary-card loss';
                totalProfit.className = 'summary-card-value loss';
            }
            
            // Create or update chart
            createProfitChart(totalExp, effectiveSales, effectiveProf);
            
            if (completedItems.length === 0) {
                profitItems.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <p class="empty-state-text">No completed items for profit analysis yet.</p>
                    </div>
                `;
                return;
            }
            
            // Sort by priority
            completedItems.sort((a, b) => {
                const priorityOrder = { high: 0, medium: 1, low: 2 };
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            });
            
            // Group by store
            const groupedItems = groupItemsByStore(completedItems);
            
            // Render items
            let html = '';
            for (const store in groupedItems) {
                html += `
                    <div class="profit-store-section">
                        <div class="profit-store-header">
                            <div class="profit-store-name">${store}</div>
                        </div>
                `;
                
                groupedItems[store].forEach(item => {
                    const qty = item.quantity || 1;
                    const buying = item.price || 0;
                    const selling = item.selling_price || 0;
                    const profit = (selling - buying) * qty;
                    const profitClass = profit > 0 ? 'positive' : profit < 0 ? 'negative' : '';
                    
                    html += `
                        <div class="profit-item">
                            <div class="profit-item-name">${item.name}</div>
                            <div class="profit-item-quantity">Qty: ${qty}</div>
                            <input type="number" class="profit-item-buying" data-id="${item.id}" value="${buying.toFixed(2)}" step="0.01" min="0">
                            <input type="number" class="profit-item-selling" data-id="${item.id}" value="${selling.toFixed(2)}" step="0.01" min="0">
                            <div class="profit-item-profit ${profitClass}">Rs ${profit.toFixed(2)}</div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            profitItems.innerHTML = html;
            
            // Add event listeners to inputs
            document.querySelectorAll('.profit-item-buying').forEach(input => {
                input.addEventListener('input', (e) => {
                    const itemId = e.target.dataset.id;
                    const newValue = parseFloat(e.target.value) || 0;
                    updateItemBuyingPrice(itemId, newValue);
                    renderProfit();
                });
            });
            
            document.querySelectorAll('.profit-item-selling').forEach(input => {
                input.addEventListener('input', (e) => {
                    const itemId = e.target.dataset.id;
                    const newValue = parseFloat(e.target.value) || 0;
                    updateItemSellingPrice(itemId, newValue);
                    renderProfit();
                });
            });
        }

        // Update item buying price (item.price)
        function updateItemBuyingPrice(itemId, price) {
            const index = items.findIndex(item => item.id === itemId);
            if (index === -1) return;
            items[index].price = price;
            saveItemsToStorage();
        }

        // Update item selling price
        function updateItemSellingPrice(itemId, price) {
            const index = items.findIndex(item => item.id === itemId);
            if (index === -1) return;
            items[index].selling_price = price;
            saveItemsToStorage();
        }

        // Create profit chart
        function createProfitChart(expenditure, sales, profit) {
            const ctx = document.getElementById('profitChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (profitChart) {
                profitChart.destroy();
            }
            
            profitChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Expenditure', 'Sales', 'Profit'],
                    datasets: [{
                        label: 'Amount (Rs)',
                        data: [expenditure, sales, profit],
                        backgroundColor: [
                            'rgba(59, 130, 246, 0.7)',  // Blue for expenditure
                            'rgba(16, 185, 129, 0.7)',  // Green for sales
                            profit >= 0 ? 'rgba(16, 185, 129, 0.7)' : 'rgba(239, 68, 68, 0.7)'  // Green for profit, red for loss
                        ],
                        borderColor: [
                            'rgb(59, 130, 246)',
                            'rgb(16, 185, 129)',
                            profit >= 0 ? 'rgb(16, 185, 129)' : 'rgb(239, 68, 68)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return 'Rs ' + value.toFixed(2);
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': Rs ' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // Update store filter options
        function updateStoreFilter() {
            const stores = [...new Set(items.map(item => item.store))];
            
            filterStoreSelect.innerHTML = '<option value="all">All Stores</option>';
            stores.forEach(store => {
                filterStoreSelect.innerHTML += `<option value="${store}">${store}</option>`;
            });
        }

        // Show cart modal
        function showCart() {
            // Get only active items
            const activeItems = items.filter(item => !item.completed);
            
            if (activeItems.length === 0) {
                showNotification('Cart Empty', 'No active items to display in cart', false, 'info');
                return;
            }
            
            // Clear selected items
            selectedItems.clear();
            
            // Reset select all checkbox
            cartSelectAllCheckbox.checked = false;
            
            // Sort items by priority (high to low)
            activeItems.sort((a, b) => {
                const priorityOrder = { high: 0, medium: 1, low: 2 };
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            });
            
            // Group items by store
            const groupedItems = groupItemsByStore(activeItems);
            
            // Populate cart items
            let itemsHtml = '';
            for (const store in groupedItems) {
                itemsHtml += `
                    <div class="cart-store-section">
                        <div class="cart-store-header">
                            <div class="cart-store-select-all">
                                <input type="checkbox" class="cart-store-select-all-checkbox" data-store="${store}">
                                <label for="store-${store}">${store}</label>
                            </div>
                            <span class="cart-store-count">${groupedItems[store].length}</span>
                        </div>
                        <div class="cart-store-items">
                `;
                
                groupedItems[store].forEach((item, index) => {
                    const itemTotal = (item.quantity || 1) * (item.price || 0);
                    const saleTotal = (item.quantity || 1) * (item.selling_price || 0);
                    const profit = saleTotal - itemTotal;
                    const profitClass = profit >= 0 ? '' : 'negative';
                    
                    itemsHtml += `
                        <div class="cart-item">
                            <input type="checkbox" class="cart-item-checkbox" data-id="${item.id}" data-store="${store}">
                            <div class="cart-item-details">
                                <div class="cart-item-name">
                                    ${item.name}
                                    <div class="cart-item-quantity">
                                        <button class="quantity-btn" data-id="${item.id}" data-action="decrease">
                                            <i class="fas fa-minus"></i>
                                        </button>
                                        <span class="quantity-value" id="quantity-${item.id}">${item.quantity || 1}</span>
                                        <button class="quantity-btn" data-id="${item.id}" data-action="increase">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="cart-item-price">
                                    <input type="number" 
                                           class="price-input" 
                                           id="price-${item.id}" 
                                           data-id="${item.id}"
                                           value="${item.price || 0}" 
                                           step="0.01" 
                                           min="0"
                                           placeholder="0.00"
                                           ${item.priceLocked ? 'disabled' : ''}>
                                    <button class="lock-btn ${item.priceLocked ? 'locked' : ''}" 
                                            data-id="${item.id}" 
                                            title="${item.priceLocked ? 'Unlock price' : 'Lock price'}">
                                        <i class="fas fa-${item.priceLocked ? 'lock' : 'unlock'}"></i>
                                    </button>
                                </div>
                                <div class="cart-item-sale-price">
                                    <input type="number" 
                                           class="sale-price-input" 
                                           id="sale-price-${item.id}" 
                                           data-id="${item.id}"
                                           value="${item.selling_price || 0}" 
                                           step="0.01" 
                                           min="0"
                                           placeholder="0.00"
                                           ${item.salePriceLocked ? 'disabled' : ''}>
                                    <button class="lock-btn ${item.salePriceLocked ? 'locked' : ''}" 
                                            data-id="${item.id}" 
                                            data-type="sale"
                                            title="${item.salePriceLocked ? 'Unlock sale price' : 'Lock sale price'}">
                                        <i class="fas fa-${item.salePriceLocked ? 'lock' : 'unlock'}"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="cart-item-total" id="total-${item.id}">Rs ${itemTotal.toFixed(2)}</div>
                            <div class="cart-item-profit ${profitClass}" id="profit-${item.id}">Rs ${profit.toFixed(2)}</div>
                        </div>
                    `;
                });
                
                let storeTotal = 0;
                let storeSaleTotal = 0;
                let storeProfit = 0;
                groupedItems[store].forEach(item => {
                    storeTotal += (item.quantity || 1) * (item.price || 0);
                    storeSaleTotal += (item.quantity || 1) * (item.selling_price || 0);
                });
                storeProfit = storeSaleTotal - storeTotal;
                
                itemsHtml += `
                        </div>
                        <div class="cart-store-total">
                            <div>Buying: Rs ${storeTotal.toFixed(2)}</div>
                            <div>Sales: Rs ${storeSaleTotal.toFixed(2)}</div>
                            <div>Profit: Rs ${storeProfit.toFixed(2)}</div>
                        </div>
                    </div>
                `;
            }
            
            cartItems.innerHTML = itemsHtml;
            
            // Add event listeners to checkboxes
            document.querySelectorAll('.cart-item-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const itemId = e.target.dataset.id;
                    const store = e.target.dataset.store;
                    if (e.target.checked) {
                        selectedItems.add(itemId);
                    } else {
                        selectedItems.delete(itemId);
                    }
                    updateCartSelectAllCheckboxes();
                    updateCartStoreSelectAllCheckbox(store);
                });
            });
            
            // Add event listeners to store select all checkboxes
            document.querySelectorAll('.cart-store-select-all-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const store = e.target.dataset.store;
                    const storeItems = document.querySelectorAll(`.cart-item-checkbox[data-store="${store}"]`);
                    const isChecked = e.target.checked;
                    
                    storeItems.forEach(itemCheckbox => {
                        itemCheckbox.checked = isChecked;
                        const itemId = itemCheckbox.dataset.id;
                        if (isChecked) {
                            selectedItems.add(itemId);
                        } else {
                            selectedItems.delete(itemId);
                        }
                    });
                    
                    updateCartSelectAllCheckboxes();
                });
            });
            
            // Add event listeners to quantity buttons
            document.querySelectorAll('.quantity-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const itemId = btn.dataset.id;
                    const action = btn.dataset.action;
                    updateItemQuantity(itemId, action);
                });
            });
            
            // Add event listeners to price inputs
            document.querySelectorAll('.price-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const itemId = e.target.dataset.id;
                    updateItemPrice(itemId, parseFloat(e.target.value) || 0);
                });
            });
            
            // Add event listeners to sale price inputs
            document.querySelectorAll('.sale-price-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const itemId = e.target.dataset.id;
                    updateItemSalePrice(itemId, parseFloat(e.target.value) || 0);
                });
            });
            
            // Add event listeners to lock buttons
            document.querySelectorAll('.lock-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const itemId = btn.dataset.id;
                    const type = btn.dataset.type || 'buying';
                    togglePriceLock(itemId, type);
                });
            });
            
            cartModal.style.display = 'flex';
        }

        // Update item quantity
        function updateItemQuantity(itemId, action) {
            const index = items.findIndex(item => item.id === itemId);
            if (index === -1) return;
            
            const item = items[index];
            const currentQuantity = item.quantity || 1;
            
            if (action === 'increase') {
                item.quantity = currentQuantity + 1;
            } else if (action === 'decrease' && currentQuantity > 1) {
                item.quantity = currentQuantity - 1;
            }
            
            // Update UI
            const quantityEl = document.getElementById(`quantity-${itemId}`);
            const totalEl = document.getElementById(`total-${itemId}`);
            const profitEl = document.getElementById(`profit-${itemId}`);
            
            if (quantityEl) {
                quantityEl.textContent = item.quantity;
            }
            
            if (totalEl) {
                const itemTotal = item.quantity * (item.price || 0);
                totalEl.textContent = `Rs ${itemTotal.toFixed(2)}`;
            }
            
            if (profitEl) {
                const saleTotal = item.quantity * (item.selling_price || 0);
                const itemTotal = item.quantity * (item.price || 0);
                const profit = saleTotal - itemTotal;
                profitEl.textContent = `Rs ${profit.toFixed(2)}`;
                profitEl.className = `cart-item-profit ${profit >= 0 ? '' : 'negative'}`;
            }
            
            // Save to storage
            saveItemsToStorage();
        }

        // Update item price
        function updateItemPrice(itemId, price) {
            const index = items.findIndex(item => item.id === itemId);
            if (index === -1) return;
            
            const item = items[index];
            item.price = price;
            
            // Update total and profit
            const totalEl = document.getElementById(`total-${itemId}`);
            const profitEl = document.getElementById(`profit-${itemId}`);
            
            if (totalEl) {
                const itemTotal = (item.quantity || 1) * price;
                totalEl.textContent = `Rs ${itemTotal.toFixed(2)}`;
            }
            
            if (profitEl) {
                const saleTotal = (item.quantity || 1) * (item.selling_price || 0);
                const itemTotal = (item.quantity || 1) * price;
                const profit = saleTotal - itemTotal;
                profitEl.textContent = `Rs ${profit.toFixed(2)}`;
                profitEl.className = `cart-item-profit ${profit >= 0 ? '' : 'negative'}`;
            }
            
            // Save to storage
            saveItemsToStorage();
        }

        // Update item sale price
        function updateItemSalePrice(itemId, price) {
            const index = items.findIndex(item => item.id === itemId);
            if (index === -1) return;
            
            const item = items[index];
            item.selling_price = price;
            
            // Update profit
            const profitEl = document.getElementById(`profit-${itemId}`);
            
            if (profitEl) {
                const saleTotal = (item.quantity || 1) * price;
                const itemTotal = (item.quantity || 1) * (item.price || 0);
                const profit = saleTotal - itemTotal;
                profitEl.textContent = `Rs ${profit.toFixed(2)}`;
                profitEl.className = `cart-item-profit ${profit >= 0 ? '' : 'negative'}`;
            }
            
            // Save to storage
            saveItemsToStorage();
        }

        // Toggle price lock - UPDATED: Now handles both buy and sale prices
        function togglePriceLock(itemId, type = 'buying') {
            const index = items.findIndex(item => item.id === itemId);
            if (index === -1) return;
            
            const item = items[index];
            
            if (type === 'buying') {
                item.priceLocked = !item.priceLocked;
                
                // If locking, update locked price
                if (item.priceLocked && item.price > 0) {
                    updateLockedPrice(item.name, item.price);
                }
                
                // Update UI
                const priceInput = document.getElementById(`price-${itemId}`);
                const lockBtn = document.querySelector(`.lock-btn[data-id="${itemId}"]:not([data-type])`);
                
                if (priceInput) {
                    priceInput.disabled = item.priceLocked;
                }
                
                if (lockBtn) {
                    lockBtn.className = `lock-btn ${item.priceLocked ? 'locked' : ''}`;
                    lockBtn.innerHTML = `<i class="fas fa-${item.priceLocked ? 'lock' : 'unlock'}"></i>`;
                    lockBtn.title = item.priceLocked ? 'Unlock price' : 'Lock price';
                }
            } else if (type === 'sale') {
                item.salePriceLocked = !item.salePriceLocked;
                
                // If locking, update locked sale price
                if (item.salePriceLocked && item.selling_price > 0) {
                    updateLockedSalePrice(item.name, item.selling_price);
                }
                
                // Update UI
                const salePriceInput = document.getElementById(`sale-price-${itemId}`);
                const lockBtn = document.querySelector(`.lock-btn[data-id="${itemId}"][data-type="sale"]`);
                
                if (salePriceInput) {
                    salePriceInput.disabled = item.salePriceLocked;
                }
                
                if (lockBtn) {
                    lockBtn.className = `lock-btn ${item.salePriceLocked ? 'locked' : ''}`;
                    lockBtn.innerHTML = `<i class="fas fa-${item.salePriceLocked ? 'lock' : 'unlock'}"></i>`;
                    lockBtn.title = item.salePriceLocked ? 'Unlock sale price' : 'Lock sale price';
                }
            }
            
            // Save to storage
            saveItemsToStorage();
        }

        // Update cart select all checkboxes
        function updateCartSelectAllCheckboxes() {
            const allCheckboxes = document.querySelectorAll('.cart-item-checkbox');
            const checkedCount = document.querySelectorAll('.cart-item-checkbox:checked').length;
            
            cartSelectAllCheckbox.checked = allCheckboxes.length === checkedCount && allCheckboxes.length > 0;
        }

        // Update cart store select all checkbox
        function updateCartStoreSelectAllCheckbox(store) {
            const storeCheckboxes = document.querySelectorAll(`.cart-item-checkbox[data-store="${store}"]`);
            const checkedCount = document.querySelectorAll(`.cart-item-checkbox[data-store="${store}"]:checked`).length;
            const storeSelectAllCheckbox = document.querySelector(`.cart-store-select-all-checkbox[data-store="${store}"]`);
            
            if (storeSelectAllCheckbox) {
                storeSelectAllCheckbox.checked = storeCheckboxes.length === checkedCount && storeCheckboxes.length > 0;
            }
        }

        // Toggle cart select all
        function toggleCartSelectAll() {
            const checkboxes = document.querySelectorAll('.cart-item-checkbox');
            const storeSelectAllCheckboxes = document.querySelectorAll('.cart-store-select-all-checkbox');
            const isChecked = cartSelectAllCheckbox.checked;
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
                const itemId = checkbox.dataset.id;
                if (isChecked) {
                    selectedItems.add(itemId);
                } else {
                    selectedItems.delete(itemId);
                }
            });
            
            storeSelectAllCheckboxes.forEach(storeCheckbox => {
                storeCheckbox.checked = isChecked;
            });
        }

        // Share cart bill via WhatsApp - FIXED: Only share selected items
        function shareCartBillViaWhatsApp() {
            if (selectedItems.size === 0) {
                showNotification('No Items Selected', 'Please select at least one item to share', true);
                return;
            }
            
            // Get only selected items
            const selectedItemsList = items.filter(item => 
                !item.completed && selectedItems.has(item.id)
            );
            
            if (selectedItemsList.length === 0) {
                showNotification('No Items Selected', 'Please select at least one item to share', true);
                return;
            }
            
            // Sort selected items by priority
            selectedItemsList.sort((a, b) => {
                const priorityOrder = { high: 0, medium: 1, low: 2 };
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            });
            
            // Group selected items by store
            const groupedSelectedItems = groupItemsByStore(selectedItemsList);
            
            // Create bill message with clean format
            let message = '🛒 Billing Summary (Selected Items)\n\n';
            let grandTotal = 0;
            
            for (const store in groupedSelectedItems) {
                message += `Store: ${store}\n`;
                let storeSubtotal = 0;
                
                groupedSelectedItems[store].forEach((item, index) => {
                    const itemTotal = (item.quantity || 1) * (item.price || 0);
                    storeSubtotal += itemTotal;
                    grandTotal += itemTotal;
                    
                    message += `${index + 1}) ${item.name} — Qty: ${item.quantity || 1} — Price: Rs ${(item.price || 0).toFixed(2)} — Total: Rs ${itemTotal.toFixed(2)}\n`;
                });
                
                message += `Store Subtotal: Rs ${storeSubtotal.toFixed(2)}\n\n`;
            }
            
            message += '-----------------------------\n';
            message += `Total Bill: Rs ${grandTotal.toFixed(2)}\n\n`;
            message += `Generated on ${new Date().toLocaleDateString()}`;
            
            // Use the new share function
            shareWhatsApp(message);
        }

        // Share cart list via WhatsApp - Only share selected items
        function shareCartListViaWhatsApp() {
            if (selectedItems.size === 0) {
                showNotification('No Items Selected', 'Please select at least one item to share', true);
                return;
            }
            
            // Get only selected items
            const selectedItemsList = items.filter(item => 
                !item.completed && selectedItems.has(item.id)
            );
            
            if (selectedItemsList.length === 0) {
                showNotification('No Items Selected', 'Please select at least one item to share', true);
                return;
            }
            
            // Sort selected items by priority
            selectedItemsList.sort((a, b) => {
                const priorityOrder = { high: 0, medium: 1, low: 2 };
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            });
            
            // Group selected items by store
            const groupedSelectedItems = groupItemsByStore(selectedItemsList);
            
            // Create message
            let message = '';
            
            for (const store in groupedSelectedItems) {
                message += `${store}\n\n`;
                groupedSelectedItems[store].forEach((item, index) => {
                    message += `${index + 1}. ${item.name}\n`;
                });
                message += '\n';
            }
            
            // Use the new share function
            shareWhatsApp(message);
        }

        // Share billing via WhatsApp
        function shareBillingViaWhatsApp() {
            const activeItems = items.filter(item => !item.completed);
            
            if (activeItems.length === 0) {
                showNotification('No Items', 'No items to share in bill', true);
                return;
            }
            
            // Sort items by priority
            activeItems.sort((a, b) => {
                const priorityOrder = { high: 0, medium: 1, low: 2 };
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            });
            
            // Group items by store
            const groupedItems = groupItemsByStore(activeItems);
            
            // Create bill message
            let message = '🛒 Billing Summary\n\n';
            let grandTotal = 0;
            
            for (const store in groupedItems) {
                message += `Store: ${store}\n`;
                let storeSubtotal = 0;
                
                groupedItems[store].forEach((item, index) => {
                    const itemTotal = (item.quantity || 1) * (item.price || 0);
                    storeSubtotal += itemTotal;
                    grandTotal += itemTotal;
                    
                    message += `${index + 1}) ${item.name} — Qty: ${item.quantity || 1} — Price: Rs ${(item.price || 0).toFixed(2)} — Total: Rs ${itemTotal.toFixed(2)}\n`;
                });
                
                message += `Store Subtotal: Rs ${storeSubtotal.toFixed(2)}\n\n`;
            }
            
            message += '-----------------------------\n';
            message += `Total Bill: Rs ${grandTotal.toFixed(2)}\n\n`;
            message += `Generated on ${new Date().toLocaleDateString()}`;
            
            // Use the new share function
            shareWhatsApp(message);
        }

        // Show share list modal
        function showShareList(storeFilterParam = null) {
            const storeFilter = storeFilterParam || filterStoreSelect.value;
            
            // If no specific store is selected, show all active items
            let activeItems = items.filter(item => !item.completed);
            
            if (storeFilter !== 'all') {
                activeItems = activeItems.filter(item => item.store === storeFilter);
            }
            
            if (activeItems.length === 0) {
                showNotification('No Items', 'No active items to share', true);
                return;
            }
            
            // Clear selected items
            selectedItems.clear();
            
            // Sort items by priority (high to low)
            activeItems.sort((a, b) => {
                const priorityOrder = { high: 0, medium: 1, low: 2 };
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            });
            
            // Group items by store
            const groupedItems = groupItemsByStore(activeItems);
            
            // Set title
            if (storeFilter === 'all') {
                shareListTitle.textContent = 'All Items';
            } else {
                shareListTitle.textContent = storeFilter;
            }
            
            // Set current date
            const today = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            shareListDate.textContent = today.toLocaleDateString(undefined, options);
            
            // Reset select all checkbox
            selectAllCheckbox.checked = false;
            
            // Populate items with checkboxes
            let itemsHtml = '';
            let grandTotal = 0;
            for (const store in groupedItems) {
                let storeTotal = 0;
                groupedItems[store].forEach(item => {
                    storeTotal += (item.quantity || 1) * (item.price || 0);
                });
                grandTotal += storeTotal;
                itemsHtml += `
                    <div class="share-store-section">
                        <div class="share-store-header">
                            <div class="share-store-info">
                                <div class="share-store-select-all">
                                    <input type="checkbox" class="share-store-select-all-checkbox" data-store="${store}">
                                    <label for="share-store-${store}">${store}</label>
                                </div>
                                <span class="share-store-count">${groupedItems[store].length}</span>
                            </div>
                            <div class="share-store-total">Total: Rs ${storeTotal.toFixed(2)}</div>
                        </div>
                        <div class="share-store-items">
                `;
                groupedItems[store].forEach((item, index) => {
                    itemsHtml += `
                        <div class="share-list-item">
                            <div class="share-list-item-number">${index + 1}</div>
                            <input type="checkbox" class="share-list-item-checkbox" data-id="${item.id}" data-store="${store}">
                            <div class="share-list-item-name">${item.name}</div>
                            <span class="priority-dot priority-${item.priority}" style="margin-left: auto;"></span>
                        </div>
                    `;
                });
                itemsHtml += `
                        </div>
                    </div>
                `;
            }
            
            if (Object.keys(groupedItems).length > 1) {
                itemsHtml += `
                    <div class="share-summary">
                        <span>Grand Total:</span>
                        <span class="share-grand-total">Rs ${grandTotal.toFixed(2)}</span>
                    </div>
                `;
            }
            
            shareListItems.innerHTML = itemsHtml;
            
            // Add event listeners to checkboxes
            document.querySelectorAll('.share-list-item-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const itemId = e.target.dataset.id;
                    const store = e.target.dataset.store;
                    if (e.target.checked) {
                        selectedItems.add(itemId);
                    } else {
                        selectedItems.delete(itemId);
                    }
                    updateSelectAllCheckbox();
                    updateShareStoreSelectAllCheckbox(store);
                });
            });
            
            // Add event listeners to store select all checkboxes
            document.querySelectorAll('.share-store-select-all-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    const store = e.target.dataset.store;
                    const storeItems = document.querySelectorAll(`.share-list-item-checkbox[data-store="${store}"]`);
                    const isChecked = e.target.checked;
                    
                    storeItems.forEach(itemCheckbox => {
                        itemCheckbox.checked = isChecked;
                        const itemId = itemCheckbox.dataset.id;
                        if (isChecked) {
                            selectedItems.add(itemId);
                        } else {
                            selectedItems.delete(itemId);
                        }
                    });
                    
                    updateSelectAllCheckbox();
                });
            });
            
            shareModal.style.display = 'flex';
        }

        // Update select all checkbox based on individual selections
        function updateSelectAllCheckbox() {
            const checkboxes = document.querySelectorAll('.share-list-item-checkbox');
            const checkedCount = document.querySelectorAll('.share-list-item-checkbox:checked').length;
            
            selectAllCheckbox.checked = checkboxes.length === checkedCount && checkboxes.length > 0;
        }

        // Toggle select all
        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('.share-list-item-checkbox');
            const storeSelectAllCheckboxes = document.querySelectorAll('.share-store-select-all-checkbox');
            const isChecked = selectAllCheckbox.checked;
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
                const itemId = checkbox.dataset.id;
                if (isChecked) {
                    selectedItems.add(itemId);
                } else {
                    selectedItems.delete(itemId);
                }
            });
            
            storeSelectAllCheckboxes.forEach(storeCheckbox => {
                storeCheckbox.checked = isChecked;
            });
        }

        // Update share store select all checkbox
        function updateShareStoreSelectAllCheckbox(store) {
            const storeCheckboxes = document.querySelectorAll(`.share-list-item-checkbox[data-store="${store}"]`);
            const checkedCount = document.querySelectorAll(`.share-list-item-checkbox[data-store="${store}"]:checked`).length;
            const storeSelectAllCheckbox = document.querySelector(`.share-store-select-all-checkbox[data-store="${store}"]`);
            
            if (storeSelectAllCheckbox) {
                storeSelectAllCheckbox.checked = storeCheckboxes.length === checkedCount && storeCheckboxes.length > 0;
            }
        }

        // Share list via WhatsApp
        function shareListViaWhatsApp() {
            if (selectedItems.size === 0) {
                showNotification('No Items Selected', 'Please select at least one item to share', true);
                return;
            }
            
            const activeItems = items.filter(item => !item.completed);
            const selectedItemsList = activeItems.filter(item => selectedItems.has(item.id));
            
            // Sort selected items by priority (high to low)
            selectedItemsList.sort((a, b) => {
                const priorityOrder = { high: 0, medium: 1, low: 2 };
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            });
            
            // Group selected items by store
            const groupedSelectedItems = groupItemsByStore(selectedItemsList);
            
            // Create message with store names as headers
            let message = '';
            
            for (const store in groupedSelectedItems) {
                message += `${store}\n\n`;
                groupedSelectedItems[store].forEach((item, index) => {
                    message += `${index + 1}. ${item.name}\n`;
                });
                message += '\n';
            }
            
            // Use the new share function
            shareWhatsApp(message);
        }

        // NEW: Open store management popup
        function openStoreManagement() {
            renderStoreList();
            storeManagementPopup.style.display = 'flex';
        }

        // NEW: Close store management popup
        function closeStoreManagement() {
            storeManagementPopup.style.display = 'none';
        }

        // NEW: Render store list - Enhanced with better UI and no text overlap
        function renderStoreList() {
            const defaultStores = [
                'Aslam Karyana Store',
                'Adrees Karyana Store',
                'Amir Karyana Store',
                'Waqas Rangwala',
                'Babar Jafar Karyana Store',
                'Baloch Karyana Store',
                'Bakery'
            ];
            
            let html = '';
            
            // Add default stores (non-editable)
            defaultStores.forEach(store => {
                html += `
                    <div class="store-item">
                        <div class="store-name">${store}</div>
                        <div class="store-actions">
                            <button class="store-edit-btn disabled" title="Default store cannot be edited">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="store-delete-btn disabled" title="Default store cannot be deleted">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            // Add custom stores (editable)
            customStores.forEach(store => {
                html += `
                    <div class="store-item" data-store="${store}">
                        <div class="store-name">${store}</div>
                        <div class="store-actions">
                            <button class="store-edit-btn" title="Edit store">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="store-delete-btn" title="Delete store">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            storeList.innerHTML = html;
            
            // Add event listeners for edit and delete buttons
            document.querySelectorAll('.store-edit-btn:not(.disabled)').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const storeItem = e.target.closest('.store-item');
                    const storeName = storeItem.dataset.store;
                    editStore(storeName, storeItem);
                });
            });
            
            document.querySelectorAll('.store-delete-btn:not(.disabled)').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const storeItem = e.target.closest('.store-item');
                    const storeName = storeItem.dataset.store;
                    deleteStore(storeName);
                });
            });
        }

        // NEW: Edit store
        function editStore(storeName, storeItem) {
            const storeNameElement = storeItem.querySelector('.store-name');
            const originalName = storeNameElement.textContent;
            
            storeNameElement.innerHTML = `
                <input type="text" class="store-edit-input" value="${originalName}">
            `;
            
            const input = storeNameElement.querySelector('.store-edit-input');
            input.focus();
            input.select();
            
            input.addEventListener('blur', saveStoreEdit);
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveStoreEdit(e);
                }
            });
            
            function saveStoreEdit(e) {
                const newName = input.value.trim();
                
                if (!newName) {
                    storeNameElement.textContent = originalName;
                    return;
                }
                
                if (newName !== originalName && isDuplicateStore(newName)) {
                    showNotification('Error', 'Store name already exists', true);
                    storeNameElement.textContent = originalName;
                    return;
                }
                
                // Update store name in custom stores array
                const index = customStores.indexOf(originalName);
                if (index !== -1) {
                    customStores[index] = newName;
                    saveCustomStores();
                }
                
                // Update store name in all items
                items.forEach(item => {
                    if (item.store === originalName) {
                        item.store = newName;
                    }
                });
                saveItemsToStorage();
                
                // Update UI
                updateStoreDropdowns();
                renderItems();
                renderStoreList();
                
                showNotification('Store Updated', `Store renamed to "${newName}"`);
            }
        }

        // NEW: Delete store
        function deleteStore(storeName) {
            if (!confirm(`Are you sure you want to delete the store "${storeName}"?`)) {
                return;
            }
            
            // Remove from custom stores
            const index = customStores.indexOf(storeName);
            if (index !== -1) {
                customStores.splice(index, 1);
                saveCustomStores();
            }
            
            // Update items to use default store
            const defaultStore = 'Aslam Karyana Store';
            items.forEach(item => {
                if (item.store === storeName) {
                    item.store = defaultStore;
                }
            });
            saveItemsToStorage();
            
            // Update UI
            updateStoreDropdowns();
            renderItems();
            renderStoreList();
            
            showNotification('Store Deleted', `Store "${storeName}" has been deleted and items moved to ${defaultStore}`);
        }

        // NEW: Save custom store
        function saveCustomStore() {
            const storeName = customStoreInput.value.trim();
            
            if (!storeName) {
                showNotification('Error', 'Please enter a store name', true);
                return;
            }
            
            if (isDuplicateStore(storeName)) {
                showNotification('Error', 'Store name already exists', true);
                return;
            }
            
            // Add to custom stores
            customStores.push(storeName);
            saveCustomStores();
            
            // Update dropdowns
            updateStoreDropdowns();
            
            // Set as selected store
            quickItemStoreSelect.value = storeName;
            lastUsedStore = storeName;
            
            // Clear and hide custom store input
            customStoreInput.value = '';
            customStoreOption.style.display = 'none';
            storeAlreadyExists.style.display = 'none';
            temporaryCustomStore = '';
            
            showNotification('Store Saved', `"${storeName}" has been added to your stores`);
        }

        // NEW: Check for duplicate store names
        function isDuplicateStore(storeName) {
            const allStores = [
                'Aslam Karyana Store',
                'Adrees Karyana Store',
                'Amir Karyana Store',
                'Waqas Rangwala',
                'Babar Jafar Karyana Store',
                'Baloch Karyana Store',
                'Bakery',
                'Other'
            ].concat(customStores);
            
            return allStores.some(store => 
                store.toLowerCase() === storeName.toLowerCase()
            );
        }

        // NEW: Update store dropdowns with custom stores
        function updateStoreDropdowns() {
            // Update quick add store dropdown
            updateStoreSelect(quickItemStoreSelect);
            
            // Update move modal store dropdown
            updateStoreSelect(moveToStore);
            
            // Update store filter dropdown
            updateStoreFilter();
        }

        // NEW: Update a store select element with custom stores
        function updateStoreSelect(selectElement) {
            const currentValue = selectElement.value;
            
            // Clear the dropdown
            selectElement.innerHTML = '';
            
            // Add default stores
            const defaultStores = [
                'Aslam Karyana Store',
                'Adrees Karyana Store',
                'Amir Karyana Store',
                'Waqas Rangwala',
                'Babar Jafar Karyana Store',
                'Baloch Karyana Store',
                'Bakery',
                'Other'
            ];
            
            defaultStores.forEach(store => {
                const option = document.createElement('option');
                option.value = store;
                option.textContent = store;
                selectElement.appendChild(option);
            });
            
            // Add custom stores
            customStores.forEach(store => {
                const option = document.createElement('option');
                option.value = store;
                option.textContent = store;
                selectElement.appendChild(option);
            });
            
            // Restore previous value if it exists
            if (currentValue && [...selectElement.options].some(opt => opt.value === currentValue)) {
                selectElement.value = currentValue;
            }
        }

        // NEW: Filter profit items
        function filterProfitItems(query) {
            const profitItems = document.querySelectorAll('.profit-item');
            
            profitItems.forEach(item => {
                const itemName = item.querySelector('.profit-item-name').textContent.toLowerCase();
                if (itemName.includes(query)) {
                    item.style.display = 'grid';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        // Local storage functions
        function saveItemsToStorage() {
            localStorage.setItem('swiftCartItems', JSON.stringify(items));
        }

        function loadItemsFromStorage() {
            const storedItems = localStorage.getItem('swiftCartItems');
            if (storedItems) {
                items = JSON.parse(storedItems);
                
                // Ensure all items have required properties
                items = items.map(item => ({
                    ...item,
                    quantity: item.quantity || 1,
                    price: item.price || 0,
                    selling_price: item.selling_price || 0,
                    priceLocked: item.priceLocked || false,
                    salePriceLocked: item.salePriceLocked || false,
                    completedDate: item.completedDate || null
                }));

                // NEW: Fix store name from "Wapas Rangwala" to "Waqas Rangwala"
                items.forEach(item => {
                    if (item.store === 'Wapas Rangwala') {
                        item.store = 'Waqas Rangwala';
                    }
                });
                saveItemsToStorage(); // Save the correction
            }
        }

        function shareWhatsApp(message) {
          const encoded = encodeURIComponent(message);
          const appUrl = `whatsapp://send?text=${encoded}`;
          const webUrl = `https://wa.me/?text=${encoded}`;
          window.location.href = appUrl;
          setTimeout(() => { window.location.href = webUrl; }, 1500);
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>